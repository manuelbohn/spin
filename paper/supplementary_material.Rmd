---
title: "Word learning at the semantics pragmatics interface"
subtitle: "Supplementary material"
author: "Manuel Bohn, Michael Henry Tessler, Megan Merrick and Michael C. Frank"
output: 
  bookdown::pdf_document2:
    toc: yes 
    number_sections: false    
  bookdown::html_document2:
    toc: yes
    toc_float: true
    fig_caption: yes
    #code_folding: hide
    number_sections: false
bibliography: library.bib
#csl: pnas.csl
header-includes:
  \usepackage{caption}
  \renewcommand{\thetable}{S\arabic{table}} 
  \renewcommand{\thefigure}{S\arabic{figure}}
---

```{r, include = F}
library(tidyverse)
library(rwebppl)
library(brms)
library(coda)
library(ggthemes)
library(readxl)
library(ggpubr)
library(stringr)
library(matrixStats)
library(data.table)
library(langcog)
library(ggimage)
library(BayesFactor)
library(pdftools)

estimate_mode <- function(s) {
  d <- density(s)
  return(d$x[which.max(d$y)])
}


hdi_upper<- function(s){
  m <- HPDinterval(mcmc(s))
  return(m["var1","upper"])
}

hdi_lower<- function(s){
  m <- HPDinterval(mcmc(s))
  return(m["var1","lower"])
}

knitr::opts_chunk$set(echo=F, warning=FALSE, message=FALSE, size="small")

```

```{r data}
aoa_ratings <- read_xlsx(path = "../data/words_aoa_ratings.xlsx", sheet = 1)%>%
  filter(Word %in% c("carrot","duck","bread","apple","kite","horseshoe","plug","garlic","barrel","eggplant","pawn","papaya"))%>%
  mutate(mean_aoa = as.numeric(Rating.Mean),
         item = Word)%>%
  select(item,mean_aoa)


me_data <- read_csv("../data/me.csv")
prior_data <- read_csv("../data/novelty.csv")
comb_data <- read_csv("../data/combination.csv")%>%
  mutate(model = "data")%>%
  left_join(aoa_ratings) %>%
  ungroup()%>%
  mutate(item = fct_reorder(factor(item), mean_aoa))

```

# Overview

The goal of this study is to investigate the integration of information during word learning in children between 2 and 5 years of age. As a first step, we replicate earlier work showing that children rely on different forms of pragmatic and semantic information during word learning. In [Experiment 1](#experiment-1-mutual-exclusivity), we show that children make a so-called mutual exclusivity inference and that this inference depends on children's developing semantic knowledge. In [Experiment 2](#experiment-2-common-ground), we show that children make inferences about word meanings based on common ground. In [Experiment 3](#experiment-3-combination), we show that, when combined in one procedure, children are sensitive to the way that the two inferences are aligned.

[Next](#cognitive-models), we introduce a computational cognitive model (**integration model**) in which we formalize the process of how information sources are integrated. As part of this, we identify three information sources that children consider when making the alleged inferences: semantic knowledge, expectations about speaker informativeness and sensitivity to common ground. We then use the our modelling framework to ask which of these information sources are necessary to [predict](#prediction) children's responses in Experiment 3. 

In the [final section](#explanation), we turn to the process by which information is integrated. We contrast the process of Bayesian inference we introduced in our model with a biased integration process in which some inforamtion sources are weighted as more important. As part of this, we also explore alternative ways to think about developmental change in the integration process. 

# Empirical studies

## Experiment 1: Mutual exclusivity

The first experiment tested the so-called mutual exclusivity inference in children between 2 and 5 years of age. The general inference can be described as follows: when presented with a familiar and an unfamiliar object, children expect a novel word to refer to the unfamiliar object [e.g. @markman1988children]. A range of explanations have been put forward for the cognitive basis of this inference [see @lewis2020-me for a discussion]. Here, we treat mutual exclusivity as a pragmatic phenomenon [e.g. @clark1987principle]. The inference process is specified in the model below. 

The first goal of this experiment was to quantify developmental change in the age range tested. The second goal was to test the role of semantic knowledge [cf. @lewis2020-me]. The assumption is that the strength of the mutual exclusivity inference varies with knowledge of the word for the familiar object presented alongside the novel object. That is, when the familiar object is an object for which children are less likely to know the word, they are less likely to assume that the novel word refers to the unfamiliar object. To test this, we systematically varied the familiar object that were presented alongside the novel object.

The experiment was preregistered at https://osf.io/gy37b. The experiment itself can be run by downloading the associated repository (https://github.com/manuelbohn/spin) and opening the file `experiments/ex1_me.html`.

### Participants

We tested a total number of `r length(unique(me_data$subid))` children, including `r length(unique(me_data$subid[me_data$subage == 2]))` 2-year-olds (range = `r format(round(min(me_data$age_num[me_data$subage == 2]),2), nsmall = 2)` - `r format(round(max(me_data$age_num[me_data$subage == 2]),2), nsmall = 2)`, 15 girls), `r length(unique(me_data$subid[me_data$subage == 3]))` 3-year-olds (range = `r format(round(min(me_data$age_num[me_data$subage == 3]),2), nsmall = 2)` - `r format(round(max(me_data$age_num[me_data$subage == 3]),2), nsmall = 2)`, 22 girls) and  `r length(unique(me_data$subid[me_data$subage == 4]))` 4-year-olds (range = `r format(round(min(me_data$age_num[me_data$subage == 4]),2), nsmall = 2)` - `r format(round(max(me_data$age_num[me_data$subage == 4]),2), nsmall = 2)`, 16 girls). Data from 10 additional children was not included because they were either exposed to less than 75% of English at home (5), did not finish at least half of the test trials (2), the technical equipment failed (2) or their parents reported an autism spectrum disorder (1). All children were recruited from the floor of a Children’s museum in San José, California, USA. This population is characterized by diverse ethnic background (predominantly White, Asian, or mixed ethnicity) and high levels of parental education and socioeconomic status. Parents consented to their children’s participation and provided demographic information. All experiments were approved by the Stanford Institutional Review Board (protocol no. 19960).

### Procedure

The experiment was presented as an interactive picture book on a tablet computer [@frank2016using]. Figure \@ref(fig:fig1)A shows the general setup. Children saw an animal standing on a little hill between two tables. For each animal character, we recorded a set of utterances (one native English speaker per animal) that were used to talk to the child and make requests. Each experiment started with two training trials in which the speaker requested known objects (car and ball). 

In Experiment 1, on one table, there was a familiar object, on the other table, there was a novel object (drawn for the purpose of the study). The speaker requested an object by saying "Oh cool, there is a [non-word] on the table, how neat, can you give me the [non-word]?". Children responded by touching one of the objects. The location of the novel object (left or right table) and the animal character were counterbalanced. Each child received 12 trials, one with each familiar object. The novel object also changed from trial to trial. We coded as correct choice if children chose the novel object as the referent of the novel word.

```{r fig1,echo = F,  fig.cap = "Schematic experimental procedure with screenshots from the experiments.", out.width="100%"}
knitr::include_graphics("../figures/method_overview.png")
```

Each child completed 12 trials, each with a different familiar and a different novel object. Familiar objects were selected to vary along the dimension of how likely children were to know the word for each object. This including objects that most 2-year-olds can name (e.g. a duck) as well as objects that only very few 5-year-olds can name (e.g. a pawn). The selection was based on age of acquisition ratings from Kuperman and colleagues [-@kuperman2012age]. While these ratings do not capture the absolute age when children acquire these words, they capture the relative order in which words are learned. Figure \@ref(fig:fig2)A shows the words and objects used in the experiment. We induced this variation to estimate the role of semantic knowledge in a mutual exclusivity inference. 

```{r, include = F}
plot_aoa_ratings <- aoa_ratings%>%
  mutate(image = paste("../experiments/images/",item,".png", sep=""))

plot_aoa <- ggplot(plot_aoa_ratings, aes(x = reorder(item, mean_aoa), y = mean_aoa)) +
  geom_point(size =2, pch = 4, aes(col = item))+
  ylab("Mean rated age of acquisition")+
  xlab("Object")+
  ylim(0,15)+
  geom_image(aes(image=image, y = mean_aoa+2), asp = 4)+
  theme_light()+
    theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_colour_viridis_d()+
  guides(col = F)
  
```

### Results

```{r table1, echo=F}
chance_me <- me_data %>%
  group_by(subage, subid) %>%
  summarise(correct = mean(correct)) %>%
  summarise(correct = list(correct)) %>%
  group_by(subage)%>%
  mutate(Mean= round(mean(unlist(correct)),2),
         BayesFactor = format(round(extractBF(ttestBF(unlist(correct), mu = 0.5))$bf), scientific = F),
         `Age group` = subage)%>%
  ungroup()%>%
  select(`Age group`, Mean, BayesFactor)

knitr::kable(chance_me, caption = "Proportion of children choosing the novel object compared to a level expected by chance based on a one sample Bayesian t-test. Responses are aggregated for each participant across familiar objects.", digits = 2, align = "l")
```

As a first step, we evaluated whether children made a mutual exclusivity inference. For this analysis, we aggregated participants' responses across familiar objects. We used the function `ttestBF` from the R-package `BayesFactor` [@R-BayesFactor] to compute a Bayes Factor (BF) in favor of the hypothesis that children chose the novel object more often than expected by chance (50%). Table \@ref(tab:table1) shows that all age groups made the inference.

```{r, echo=F}
# prior_me <- c(prior(normal(0, 5), class = Intercept),
#            prior(normal(0, 5), class = b),
#            prior(cauchy(0, 1), class = sd))
# 
# 
# bm_me <- brm(correct ~ age + (1|subid) + (age | item) + (age | agent),
#                     data = me_data, family = bernoulli(),
#           control = list(adapt_delta = 0.99, max_treedepth = 20),
#           sample_prior = F,
#           prior = prior_me,
#           cores = 4,
#           chains = 4,
#           iter = 5000)%>%
#   saveRDS(.,"../saves/bm_me.rds")
# 
# 
# bm_me2 <- brm(correct ~ age + (1|subid) + (age | agent),
#                     data = me_data, family = bernoulli(),
#           control = list(adapt_delta = 0.99, max_treedepth = 20),
#           sample_prior = F,
#           prior = prior_me,
#           cores = 4,
#           chains = 4,
#           iter = 5000)%>%
#   saveRDS(.,"../saves/bm_me.rds")

bm_me <- readRDS("../saves/bm_me.rds")

bm_me2 <- readRDS("../saves/bm_me2.rds")

```

```{r, cache = T}
fixef_me <- as_tibble(fixef(bm_me), rownames = "term")

ranef_me <-  ranef(bm_me)

ranef_plot_me <- as_tibble(ranef_me$item, rownames = "item")%>%
  mutate(grand_intercept = fixef_me%>%filter(term=="Intercept")%>%pull(Estimate),
         grand_slope = fixef_me%>%filter(term=="age")%>%pull(Estimate))%>%
  group_by(item) %>%
  tidyr::expand(Estimate.Intercept,Estimate.age,grand_intercept,grand_slope, age = unique(me_data$age))%>%
  mutate(y = plogis(grand_intercept + Estimate.Intercept+(Estimate.age+grand_slope)*age), 
         age = age+min(me_data$age_num))%>%
  left_join(aoa_ratings)%>%
  ungroup()%>%
  mutate(item = fct_reorder(factor(item), mean_aoa))

plot_me <- ggplot(ranef_plot_me, aes(x=age,y = y, col = item))+
  geom_hline(yintercept = 0.5, lty=2)+
  geom_jitter(data = me_data%>%left_join(aoa_ratings), aes(x = age_num, y = correct, col = reorder(item, mean_aoa)), width = 0, height = 0.02, alpha = .2)+
  geom_line(size = 1)+
  labs(x="Age",y="Mutual exclusivity effect")+
  theme_few() +
  ylim(-0.05,1.05)+
  xlim(2,5)+
  guides(alpha = F)+ 
  scale_colour_viridis_d(name = "Object")

cor_plot_me <- as_tibble(ranef_me$item, rownames = "item") %>%
  left_join(aoa_ratings)%>%
  ggplot(., aes(x = mean_aoa, y = Estimate.Intercept))+
  geom_point(pch = 4, size = 2, aes(col = item))+
  geom_smooth(method = "lm", col = "black", se = F, lty = 2, size = .5)+
  xlab("Rated age of acquisition")+
  ylab("Mutual exclusivity effect (model intercept)")+
  ylim(-1,1)+
  stat_cor(method = "pearson", label.x = 6, label.y = .99)+
  theme_few()+
  scale_colour_viridis_d()+
  guides(col = F)
```

As a second step, we investigated how the inference changed as a function of age and the familiar object. We modeled the trial by trial data using a Bayesian generalized linear mixed model (GLMM). We used the function `brm` from the package `brms` [@R-brms_a]. We pre-registered the use of default priors in all models. However, the model in Experiment 3 was unable to initialize with default priors and we thus used weakly informative priors for all models to be consistent. The priors we used were $\mathcal{N}(0,5)$ for fixed (population level) effects and $\text{Cauchy}(0,1)$ for standard deviations of random effects. The model formula was `correct ~ age + (1 | id) + (age | object) + (age | agent)`. That is, we modeled an overall slope for age (continuous, anchored at the minimum) and the object specific developmental trajectories as deviations from the overall intercept and slope (random effects). We did not pre-register agent as a random effect, but retrospecitvely included it to be consistent with Experiment 2 and 3.

The estimate for age was positive and reliably different from zero (*$\beta$* = `r fixef_me%>%filter(term == "age")%>%pull(Estimate)%>%round(2)`, 95% CrI: `r fixef_me%>%filter(term == "age")%>%pull(Q2.5)%>%round(2)` - `r fixef_me%>%filter(term == "age")%>%pull(Q97.5)%>%round(2)`). Older children were more likely to make a mutual exclusivity inference. To assess the variability accross objects, we compared the fit of the above model to a model lacking `object` as a random effect. Following McElreath [-@rethinking], we compared models using WAIC (widely applicable information criterion) scores and weights. The WAIC score is an indicator of the model’s predictive accuracy for out of sample data; model’s with lower scores are preferred. WAIC weights are an estimate of the probability that this model (compared to all other models considered) will make the best predictions on new data. The model including object provided a much better fit compared to the model lacking it (see Table \@ref(tab:table2)). Figure \@ref(fig:fig2)B visualizes the model based developmental trajectory for each familiar object and illustrates the substantial variation between them, both in terms of absolute strength of the inference as well as its developmental trajectory. Figure \@ref(fig:fig2)C shows the correlation between rated age of acquisition and object specific model intercept (i.e. mutual exclusivity inference at age 2.00). The mutual exclusivity effect was stronger for words that were rated to be acquired earlier. Objects for which children were less likely to know the word produced a weaker mutual exclusivity effect. Taken together, the strength of the mutual exclusivity inference depended on age as well as the familiar object. 

```{r table2, echo=F, cache = T}

me_waic <- brms::waic(bm_me, bm_me2, compare = F)

me_weights <- model_weights(bm_me, bm_me2, weights = "waic")

me_comp <- tibble(
  Model = c("with object as RE", "without object as RE"),
  WAIC = round(c(me_waic$loos$bm_me$estimates["waic","Estimate"],me_waic$loos$bm_me2$estimates["waic","Estimate"]),2),
  SE = round(c(me_waic$loos$bm_me$estimates["waic","SE"],me_waic$loos$bm_me2$estimates["waic","SE"]),2),
  weight = format(round(c(me_weights[1],me_weights[2]),2), nsmall = 2)
)

knitr::kable(me_comp, caption = "Model comparison in Experiment 1 based on WAIC scores and weights.", digits = 2, align = "l")
```


```{r fig2, include = T, fig.cap = "A:Familiar words and corresponding pictures by rated age of acquisition. B: Developmental trajectories of mututal exclusivity effect by familiar object based on the mean of the model posterior distribution. Dots show individual datapoints. Lighter colors indicate later rated age of acquisition. Dotted line indicates a level of performance expected by chance. C: Correlation between rated age of acquisiton and mutual exclusivity effect (model based intercept for each familiar object).", fig.width=12, fig.height = 4}
ggarrange(plot_aoa, plot_me, cor_plot_me,  labels = c("A","B","C"), nrow = 1, widths = c(1,1.3,1), common.legend = F)
```

## Experiment 2: Common ground

Here we tested children's sensitivity to common ground that is build up over the course of a conversation. In particular, we tested whether children keep track of which object is new to a speaker and which they have encountered previously [@akhtar1996role; @diesendruck2004two]. The main goal of the experiment was to measure how children's sensitivity to common ground changes with age.

The experiment was preregistered at https://osf.io/au5hr. The experiment itself can be run by downloading the associated repository and opening the file `experiments/ex2_novel.html`.

### Participants

We tested `r length(unique(prior_data$subid))` children from the same general population as in Experiment 1, including `r length(unique(prior_data$subid[prior_data$subage == 2]))` 2-year-olds (range = `r format(round(min(prior_data$age_num[prior_data$subage == 2]),2), nsmall = 2)` - `r format(round(max(prior_data$age_num[prior_data$subage == 2]),2), nsmall = 2)`, 7 girls), `r length(unique(prior_data$subid[prior_data$subage == 3]))` 3-year-olds (range = `r format(round(min(prior_data$age_num[prior_data$subage == 3]),2), nsmall = 2)` - `r format(round(max(prior_data$age_num[prior_data$subage == 3]),2), nsmall = 2)`, 14 girls) and  `r length(unique(prior_data$subid[prior_data$subage == 4]))` 4-year-olds (range = `r format(round(min(prior_data$age_num[prior_data$subage == 4]),2), nsmall = 2)` - `r format(round(max(prior_data$age_num[prior_data$subage == 4]),2), nsmall = 2)`, 14 girls). Data from 5 additional children was not included because they were either exposed to less than 75% of English at home (3) or the technical equipment failed (2).

### Procedure

The general setup was the same as in Experiment 1. The speaker was positioned between the tables. There was a novel object (drawn for the purpose of the study) on one of the tables while the other table was empty. Next, the speaker turned to one of the tables and either commented on the presence ("Aha, look at that.") or the absence ("Hm, nothing there") of an object. Then the speaker disappeared. While the speaker was away, a second novel object appeared on the previously empty table. Then the speaker returned and requested an object in the same way as in Experiment 1 (see also Figure \@ref(fig:fig1)B). The positioning of the novel object in the beginning of the experiment, the speaker as well as the location the speaker turned to first was counterbalanced. Children received five trials, each with a different pair of novel objects. We coded as correct choice if children chose the object that was new to the speaker as the referent of the novel word.

### Results

```{r table3, echo=F}
chance_prior <- prior_data %>%
  group_by(subage, subid) %>%
  summarise(correct = mean(correct)) %>%
  summarise(correct = list(correct)) %>%
  group_by(subage)%>%
  mutate(Mean= round(mean(unlist(correct)),2),
         BayesFactor = format(round(extractBF(ttestBF(unlist(correct), mu = 0.5))$bf,2), scientific = F),
         `Age group` = subage)%>%
  ungroup()%>%
  select(`Age group`, Mean, BayesFactor)

knitr::kable(chance_prior, caption = "Proportion of children choosing the object that was new to the speaker compared to a level expected by chance based on a one sample Bayesian t-test. Responses are aggregated for each participant across trials.", digits = 2, align = "l")
```

Table \@ref(tab:table3) compares children's correct responses to a level expected by chance (50%). We found evidence that, as a group, 3- and 4-year-olds, but not 2-year-olds, inferred that the novel word referred to the object that was new to the speaker. 

```{r, echo=F}
# prior_cg <- c(prior(normal(0, 5), class = Intercept),
#            prior(normal(0, 5), class = b),
#            prior(cauchy(0, 1), class = sd))
# 
# 
# bm_cg <- brm(correct ~ age + (1|subid) + (age | agent),
#                     data = prior_data, family = bernoulli(),
#           control = list(adapt_delta = 0.99, max_treedepth = 20),
#           sample_prior = F,
#           prior = prior_cg,
#           cores = 4,
#           chains = 4,
#           iter = 5000)%>%
#   saveRDS(.,"../saves/bm_cg.rds")

bm_cg <- readRDS("../saves/bm_cg.rds")
```

```{r}
fixef_cg <- as_tibble(fixef(bm_cg), rownames = "term")

plot_cg_data <- prior_data %>%
  group_by(age_num, subid) %>%
  summarise(correct = mean(correct)) 

plot_cg_samples <- posterior_samples(bm_cg, "^b", subset = 1:200)%>%
  mutate(sample = 1:length(b_age))%>%
  expand_grid(.,unique(prior_data$age))%>%
  mutate(age = `unique(prior_data$age)`,
         y =  plogis(b_Intercept + b_age * age))%>%
  select(-`unique(prior_data$age)`)

plot_cg_map <- as_tibble(fixef(bm_cg), rownames = "term")%>%
  select(term, Estimate)%>%
  spread(term, Estimate)%>%
  expand_grid(.,unique(prior_data$age))%>%
  mutate(slope = age, 
         age = `unique(prior_data$age)`,
         y =  plogis(Intercept + slope * age))%>%
  select(-`unique(prior_data$age)`)

plot_cg <- ggplot() +
  geom_hline(yintercept = 1/2, lty=2, size = 1)+
  geom_jitter(data = plot_cg_data,aes(x = age_num, y= correct), width = .00, height = .01, alpha = .5)+
  geom_line(data = plot_cg_samples, aes(x = age+min(prior_data$age_num), y = y, group = sample), size = .025)+
  geom_line(data = plot_cg_map, aes(x =age+min(prior_data$age_num), y = y), size = 1)+
  labs(x="Age",y="Proportion object new to speaker chosen")+
  theme_few() +
  ylim(-0.05,1.05)+
  xlim(2,5)+
  guides(alpha = F)

```

To directly investigate whether children's response changed with age, we modeled the trial by trial data using a Bayesian GLMM (formula: `correct ~ age + (1 | id) + (age | speaker)`, specifications see [Experiment 1](#experiment-1-mutual-exclusivity)). The estimate for age was positive and reliably different from zero (*$\beta$* = `r fixef_cg%>%filter(term == "age")%>%pull(Estimate)%>%round(2)`, 95% CrI: `r fixef_cg%>%filter(term == "age")%>%pull(Q2.5)%>%round(2)` - `r fixef_cg%>%filter(term == "age")%>%pull(Q97.5)%>%round(2)`, see Figure \@ref(fig:fig3)A). Older children were more likely to chose the object that was new to the speaker as the referent of the novel word, suggesting that the sensitivity to common ground in this context increases with age.

## Experiment 3: Combination

Experiment 3 combined the procedures from Experiment 1 and 2. As a consequence, children had to consider not just their semantic knowledge of the word for the familiar object and the inference this licences but also the role that each object (novel and familiar) had played in the preceding interaction. Combining the two procedures created two alignment conditions: In the *congruent condition*, the novel object was also the object that was new to the speaker. In this case, the mutual exclusivity inference as well as the common ground inference pointed to the novel object as the referent. In the *incongurent condition*, the familiar object was new to the speaker. In this case, the two inferences pointed to different objects. The main focus of the overall study was to model how children integrate and balance these different information sources. We investigate this question in depth in the [modelling](#cognitive-models) section below. Here, we limit the discussion to whether children differentiated between the two conditions.

The experiment was preregistered at https://osf.io/4nm8g. The experiment itself can be run by downloading the associated repository and opening the file `experiments/ex3_combination.html`.

### Participants

We tested `r length(unique(comb_data$subid))` children from the same general population as in Experiment 1 and 2, including `r length(unique(comb_data$subid[comb_data$subage == 2]))` 2-year-olds (range = `r format(round(min(comb_data$age_num[comb_data$subage == 2]),2), nsmall = 2)` - `r format(round(max(comb_data$age_num[comb_data$subage == 2]),2), nsmall = 2)`, 7 girls), `r length(unique(comb_data$subid[comb_data$subage == 3]))` 3-year-olds (range = `r format(round(min(comb_data$age_num[comb_data$subage == 3]),2), nsmall = 2)` - `r format(round(max(comb_data$age_num[comb_data$subage == 3]),2), nsmall = 2)`, 14 girls) and  `r length(unique(comb_data$subid[comb_data$subage == 4]))` 4-year-olds (range = `r format(round(min(comb_data$age_num[comb_data$subage == 4]),2), nsmall = 2)` - `r format(round(max(comb_data$age_num[comb_data$subage == 4]),2), nsmall = 2)`, 14 girls). Data from 20 additional children was not included because they were either exposed to less than 75% of English at home (15), did not finish at least half of the test trials (3) or the technical equipment failed (2). 

### Procedure

Experiment 3 followed the same procedure as Experiment 2 but involved the same objects as Experiment 1 (Figure \@ref(fig:fig1)C). In the beginning, one table was empty while there was an object (novel or familiar) on the other one. After commenting on the presence or absence of an object on each table, the speaker disappeared and a second object appeared (familiar or novel). Next, the speaker re-appeared and made the usual request.

In the congruent condition, the familiar object was present in the beginning and the novel object appeared while the speaker was away (Figure \@ref(fig:fig1)C - left). In this case, both the mutual exclusivity and the common ground inference pointed to the novel object as the referent. In the incongruent condition, the novel object was present in the beginning and the familiar object appeared later. In this case, the two inferences pointed to different objects (Figure \@ref(fig:fig1)C - right).

Participants received up to 12 test trials, six in each condition, each with a different familiar and novel object. Familiar objects were the same as in Experiment 1. The positioning of the objects on the tables, the speaker and the location the speaker first turned to were counterbalanced. Participants could stop the experiment after six trials (three per condition). If a participant stopped after half of the trials, we tested an additional participant to reach a pre-registered number of data points per age group (2-, 3- and 4-year-olds).  

### Results

All results are reported from the perspective of the mutual exclusivity inference (`correct` in the model formula below). In the incongruent condition, high proportions speak to a mutual exclusivity inference and low proportion to a common ground inference. In the congruent condition, both inferences pointed in the same direction. The focus of this experiment was on information integration and we therefore did not compare the performance to chance.  

```{r, echo=F}

# prior_comb <- c(prior(normal(0, 5), class = Intercept),
#            prior(normal(0, 5), class = b),
#            prior(cauchy(0, 1), class = sd))
# 
# bm_comb <- brm(correct ~ age * alignment + (alignment | subid) + (age * alignment | item)+ (age * alignment | agent),
#                     data = comb_data, family = bernoulli(),
#           control = list(adapt_delta = 0.99, max_treedepth = 20),
#           sample_prior = F,
#           prior = prior_comb,
#           cores = 4,
#           chains = 4,
#           inits = 0,
#           iter = 5000)%>%
#   saveRDS(.,"../saves/bm_comb.rds")
# 
# bm_comb2 <- brm(correct ~ age * alignment + (alignment | subid) + (age * alignment | agent),
#                     data = comb_data, family = bernoulli(),
#           control = list(adapt_delta = 0.99, max_treedepth = 20),
#           sample_prior = F,
#           prior = prior_comb,
#           cores = 4,
#           chains = 4,
#           inits = 0,
#           iter = 5000)%>%
#   saveRDS(.,"../saves/bm_comb2.rds")

bm_comb <- readRDS("../saves/bm_comb.rds")

bm_comb2 <- readRDS("../saves/bm_comb2.rds")

```

```{r, cache = T}
fixef_comb <- as_tibble(fixef(bm_comb), rownames = "term")

ranef_comb <-  ranef(bm_comb)

plot_comb_map <- bind_rows(
  as_tibble(ranef_comb$item, rownames = "item")%>%
  mutate(condition = "congruent",
         condition_code = 0),
  as_tibble(ranef_comb$item, rownames = "item")%>%
  mutate(condition = "incongruent",
         condition_code = 1))%>%
  mutate(grand_intercept = fixef_comb%>%filter(term=="Intercept")%>%pull(Estimate),
         grand_age = fixef_comb%>%filter(term=="age")%>%pull(Estimate),
         grand_cond = fixef_comb%>%filter(term=="alignmentincongruent")%>%pull(Estimate),
         grand_intact = fixef_comb%>%filter(term=="age:alignmentincongruent")%>%pull(Estimate))%>%
  group_by(item, condition, condition_code)%>%
  expand_grid(. ,age = unique(comb_data$age))%>%
  mutate(y = plogis(grand_intercept + 
                      Estimate.Intercept +
                      grand_cond * condition_code +
                      Estimate.alignmentincongruent * condition_code +
                      grand_age * age +
                      Estimate.age * age +
                      grand_intact * (condition_code * age) +
                      `Estimate.age:alignmentincongruent` * (condition_code * age)),
         age = age+min(comb_data$age_num))%>%
  left_join(aoa_ratings)%>%
  ungroup()%>%
  mutate(item = fct_reorder(factor(item), mean_aoa))


plot_comb <- ggplot(plot_comb_map, aes(x=age,y = y, col = item))+
  geom_hline(yintercept = 0.5, lty=2)+
  geom_jitter(data = comb_data%>%left_join(aoa_ratings)%>%ungroup()%>%mutate(item = fct_reorder(factor(item), mean_aoa)), aes(x = age_num, y= correct, col = item), width = .00, height = .04, alpha = .2)+
  geom_line(size = 1)+
  labs(x="Age",y="Mutual Exclusivity effect")+
  facet_grid(~condition)+
  theme_few() +
  ylim(-0.05,1.05)+
  xlim(2,5)+
  guides(alpha = F)+ 
  scale_colour_viridis_d(name = "Object")

```

We modeled the trial by trial data in the following way: `correct ~ age * alignment + (alignment | subid) + (age * alignment | object) + (age * alignment | agent)`. We pre-registered to include item as a fixed effect in Experiment 3. However, we chose to model it as a random effect instead because, as explained in Experiment 1, items were chosen based on their rated age of acquisition. That is, we assumed that they are not necessarily different kinds but that they represent different locations on a distribution of required semantic knowledge. For further model specifications see [Experiment 1](#experiment-1-mutual-exclusivity)). 

The estimate for age was reliably positive (*$\beta$* = `r fixef_comb%>%filter(term == "age")%>%pull(Estimate)%>%round(2)`, 95% CrI: `r fixef_comb%>%filter(term == "age")%>%pull(Q2.5)%>%round(2)` - `r fixef_comb%>%filter(term == "age")%>%pull(Q97.5)%>%round(2)`). The incongruent condition had a strong negative impact (*$\beta$* = `r fixef_comb%>%filter(term == "alignmentincongruent")%>%pull(Estimate)%>%round(2)`, 95% CrI: `r fixef_comb%>%filter(term == "alignmentincongruent")%>%pull(Q2.5)%>%round(2)` - `r fixef_comb%>%filter(term == "alignmentincongruent")%>%pull(Q97.5)%>%round(2)`), showing that children showed a weaker mutual exclusivity inference when common ground information pointed to the other object as the referent. Thus, children differentiated between the two alignment conditions. The interaction term was weakly - though not entirely - negative, suggesting a shallower slope for age in the incongruent condition (*$\beta$* = `r fixef_comb%>%filter(term == "age:alignmentincongruent")%>%pull(Estimate)%>%round(2)`, 95% CrI: `r fixef_comb%>%filter(term == "age:alignmentincongruent")%>%pull(Q2.5)%>%round(2)` - `r fixef_comb%>%filter(term == "age:alignmentincongruent")%>%pull(Q97.5)%>%round(2)`). A model lacking `object` as a random effect provided a much poorer fit, suggesting substantial variation across objects (see Table \@ref(tab:table4)). Figure \@ref(fig:fig3)B visualizes the model. Taken together, the results show that children responded to the way the two inferences were aligned with one another. 

```{r table4, echo=F, cache = T}

comb_waic <- brms::waic(bm_comb, bm_comb2, compare = F)

comb_weights <- model_weights(bm_comb, bm_comb2, weights = "waic")

comb_comp <- tibble(
  Model = c("with object as RE", "without object as RE"),
  WAIC = round(c(comb_waic$loos$bm_comb$estimates["waic","Estimate"],comb_waic$loos$bm_comb2$estimates["waic","Estimate"]),2),
  SE = round(c(comb_waic$loos$bm_comb$estimates["waic","SE"],comb_waic$loos$bm_comb2$estimates["waic","SE"]),2),
  weight = format(round(c(comb_weights[1],comb_weights[2]),2), nsmall = 2)
)

knitr::kable(comb_comp, caption = "Model comparison in Experiment 3 based on WAIC scores and weights.", digits = 2, align = "l")
```


```{r fig3, include = T,  fig.cap = "Proportion of choosing the object that was new to the speaker by age. Dots show the mean response for each participant. The solid black line shows the developmental trajectory based on the mean of the model posterior distribution. Lighter lines show 200 random draws from the posterior distribution to depict uncertainty. Dotted line indicates a level of performance expected by chance.", fig.width=12, fig.height = 4}
ggarrange(plot_cg, plot_comb,  labels = c("A","B"), nrow = 1, widths = c(1,2))
```

## Discussion 

The experiments reported above show that children are sensitive to the types of information sources we intended to manipulate. Experiment 1 showed that children of all age groups make a mutual exclusivity inference, that the strength of this inference increases with age and, crucially, that it depends on children's semantic knowledge. Experiment 2 showed that children are sensitive to the common ground manipulation we implemented and that the sensitivity to common ground increases with age. Finally, Experiment 3 showed that children respond differently depending on how the mutual exclusivity inference and the common ground inference are aligned with one another. In the next section, we use Bayesian cognitive models to address the question of *how* information sources are integrated when inferences are combined with one another.

# Cognitive models

The main purpose of the study was to study *how* children integrate different information sources during word learning and how this process develops with age. To do so, we use Bayesian cognitive models of pragmatic reasoning. We first describe an **integration model** which we think best represents the inference and integration processes and then specify how this model captures developmental change. Next, we ask how well this model *predicts* how children integrate information. That is, in a situation in which we know the development trajectories for the mutual exclusivity inference (for a particular familiar object) as well as the common ground inference, what can we say about what happens when they are combined. We then test the predictive power of the model by comparing the model predictions to the data from Experiment 3. We use formal model comparison methods to test the **integration model** against a range of alternative models.   

Finally, we ask how well our model *explains* the way that children integrate the different information sources. For this analysis, we fit the free parameters in the model to all the available data, those from Experiment 1 and 2 as well as the integration data from Experiment 3. We then compare the model to a range of alternative models that make different assumptions about how information is integrated and how this process develops. This approach answers the question of how we can best explain how children integrate the different information sources. 

## Modeling framework 

The cognitive models are situated in the Rational Speech Act (RSA) framework [@frank2012predicting; @goodman2016pragmatic]. RSA models are models of pragmatic reasoning in that they treat language understanding as a special case of Bayesian social reasoning. A listener interprets an utterance by assuming it was produced by a cooperative speaker who had the goal to be informative. Being informative is defined as providing a message that would increase the probability of the listener inferring the speaker’s intended message. This notion of contextual informativeness captures the Gricean idea of cooperation between speaker and listener.

\begin{equation}
P_{L_1}(r \mid u)\propto P_{S_1}(u \mid r) \cdot P(r \mid \rho_i)
(\#eq:rsabasic1)
\end{equation}

\begin{equation}
P_{S_1}(u \mid r)\propto P_{L_0}(r\mid u) ^{\alpha_i}
(\#eq:rsabasic2)
\end{equation}

\begin{equation}
P_{L_0}(r\mid u) \propto \mathcal{L}(u, r \mid \theta_{ij})
(\#eq:rsabasic3)
\end{equation}

Our model describes a listener ($L_1$) reasoning about the referent referred to by a speaker's ($S_1$) utterance. This reasoning is contextualized by the prior probability of each referent $P(r \mid \rho_i)$. This prior probability is a function of the common ground $\rho$ shared between speaker and listener in that interacting around the objects changes the probability that they will be referred to later. We assume that the degree to which interactions around objects are integrated into the common ground (and thus change the prior probability of those objects) depends on the child's age $i$. 

To decide between referents, the listener ($L_1$) reasons about what a rational speaker ($S_1$) would say given an intended referent. This speaker is assumed to compute the informativity for each available utterance and then choose the most informative one. However, this expectation of speaker informativeness may vary and is captured by the parameter $\alpha$. In particular, we take $\alpha$ to be a function of the child's age $i$. 

The informativity of each utterance is given by imagining which referent a literal listener ($L_0$), who interprets words according to their lexicon $\mathcal{L}$, would infer upon hearing the utterance.^[
  Following @frank2014inferring, we use an implicit uniform prior over referents in the literal listener.
] Thus, this reasoning depends on what kind of semantic knowledge (word--object mappings) the speaker thinks the literal listener knows. We parameterize the listener's knowledge of a word's semantics in terms of a semantic knowledge parameter $\theta$, which varies between 0 and 1. $\theta = 0$ correspondes to the state of knowledge for a completely novel word and results in a semantic interpretation function that chooses randomly between the objects in the scene. Each of the novel words are assumed to have semantic knowledge of 0. For $\theta \in (0, 1)$, the semantic interpretation function will select the familiar referent with probability $\theta + (1 - \theta)\frac{1}{2} = \frac{1 + \theta}{2}$; that is, with probability $\theta$, the listener knows the correct meaning of the word (and picks out the correct referent 100\% of the time); with probability $1 - \theta$, the listener does not know the meaning of the word and must guess, picking out the correct referent 50\% of the time.^[
  One could also define $\theta$ to directly denote the probability of selecting the familiar vs. unfamiliar referent. The model behavior would be the same except for a translation of this parameter. We choose the parametrization described because we find it more intuitive for $\theta$ to represent the degree of semantic knowledge, where 0 semantic knowledge represents a state of complete ignorance, corresponding to maximal uncertainty about which object the word applies to. 
] For familiar objects, semantic knowledge is a function of the degree-of-acquisition of the associated word, which in turn depends upon the word $j$ (its expected acquisition trajectory) as well as on the child's age $i$. 

The model with each data-analytic parameter represented explicitly in $\{ \}$ is:

\begin{equation}
P_{L_1}(r \mid u; \{\rho_i, \alpha_i\, \theta_{ij}\})\propto P_{S_1}(u \mid r; \{\alpha_i, \theta_{ij}\}) \cdot P(r \mid \rho_i)
(\#eq:rsafull1)
\end{equation}

\begin{equation}
P_{S_1}(u \mid r; \{\alpha_i\, \theta_{ij}\})\propto P_{L_0}(r \mid u; \{\theta_{ij}\}) ^{\alpha_i}
(\#eq:rsafull2)
\end{equation}

\begin{equation}
P_{L_0}(r \mid u; \{\theta_{ij}\}) \propto \mathcal{L}(u, r \mid \theta_{ij})
(\#eq:rsafull3)
\end{equation}

## Loci of development

The model description above points to three potential loci of developmental change: semantic knowledge, expectations about speaker informativeness and sensitivity to common ground. Each of theses components is represented by a parameter that plays a particular functional role in the model. We capture developmental change by making these parameters a function of age $i$ for which we estimate a developmental trajectory (intercept and slope in a (logistic-) linear model, see Figure \@ref(fig:bda)).

### Semantic knowledge

Semantic knowledge captures the degree of certainty with which the naive listener is assumed to know the label for the familiar object. As a consequence, semantic knowledge differs among familiar words. For objects whose labels are generally acquired earlier (e.g., "carrot") semantic knowledge should generally be high whereas for others (e.g., "pawn") semantic knowledge should generally be lower. However, semantic knowledge also varies with age such that older children are more likely to know the labels for more of the familiar objects compared to younger children. As a consequence, each familiar word has a unique developmental semantic knowledge trajectory. 

Technically, the item-specific parameters ($\theta_{ij}$) are estimated in the form of a hierarchical regression (mixed-effects) model: $\theta_{ij} = \text{logistic}(\beta^{\theta}_{0, j} + i \cdot \beta^{\theta}_{1, j})$; each word's lexical development trajectory (the intercept $\beta^{\theta}_{0, j}$  and slope $\beta^{\theta}_{1, j}$ of the regression line for each object) is estimated as a deviation from an overall trajectory of vocabulary development. The intercept and slope for each item are sampled from Gaussian distributions with means $\mu^\theta_0, \mu^\theta_1$ and variances $\sigma^\theta_0, \sigma^\theta_1$: $\beta^{\theta}_{0, j} \sim \mathcal{N}(\mu^\theta_0, \sigma^\theta_0)$ and $\beta^{\theta}_{1, j} \sim \mathcal{N}(\mu^\theta_1, \sigma^\theta_1)$.
$\mu^\theta_0$ and $\mu^\theta_1$ represent the overall vocabulary development independent of particular familiar word--object pairings, and $\sigma^\theta_0$ and $\sigma^\theta_1$ represent the overall variability of intercepts and of slopes between items (see Figure \@ref(fig:bda)). For all regression components, intercepts correspond to the knowledge or sensitivity for our youngest children: 2-year-olds (2.00 years of age). For example, $\mu^\theta_0$ represents the average semantic knowledge of a 2-year-old and $\mu^\theta_1$ represents the growth in semantic knowledge over developmental time. $\sigma^\theta_0$ represents the variability in the semantic knowledge of our items (for a 2-year-old) and $\sigma^\theta_1$ represents the variability in growth of semantic knowledge across our different items.

### Expectations about speaker informativeness

A second locus of developmental change is a listener's expectations about speaker informativeness $\alpha$. In the context of the model, speaker informativeness corresponds to the degree with which the listener expects the speaker to choose the most informative of the available utterances. We assume that children at different ages could have different expectations about how rational or informative speakers are [see e.g. @bohn_tessler_merrick_frank_2019; @frank2014inferring; @yoon2019role], which we model with a linear function: $\alpha_i = \beta^\alpha_0 + i \cdot \beta^\alpha_1$.

### Sensitivity to common ground

Sensitivity to common ground $\rho$ refers to the probability that an object is taken to be the referent of the utterance, before actually hearing the utterance. In our paradigm, common ground takes the form of *discourse novelty*, and $\rho$ captures the salience (or lack thereof) of an object due to its presence or absence in the social interaction that precedes the utterance (see \@ref(fig:fig1)B). Specifically, the pragmatic listener uses the common ground parameter $\rho$ as the prior probability of the discourse-novel (i.e., the referent that was absent in the social interaction that preceded the utterance): In the *congruent* condition, the object in the prior social interaction (i.e., the discourse-familiar object) was the familiar object, and hence, both common ground (discourse novelty) and mutual exclusivity are cues to the same referent; in the *incongruent* condition, the object in the prior social interaction was the novel object, and hence, common ground (discourse-novelty) and mutual exclusitivity are cues to different referents (see Figure \@ref(fig:fig1)C).  
We expect children at different ages to respond differently to the common ground manipulation, resulting in an age specific prior distribution over objects [@akhtar1996role; @diesendruck2004two], which we model with a logistic-linear function: $\rho_i = \text{logistic}(\beta^\rho_0 + i \cdot \beta^\rho_1)$.

```{r bda, engine='tikz', echo = F , fig.cap = "Graphical model representing the Bayesian data analysis for **Integration model** used for *Explanation*. $L_1$ represents the RSA model defined by Eq. 2, used to predict the Combination Data $d^{Ex3}$ from Expt. 3 for each unique age bin $i$, lexical item $j$, and alignment condition $k$. This RSA model takes as input a speaker optimality parameter $\\alpha_i$ (which varies by age), a semantic knowledge parameter $\\theta_{ij}$ (which varies by age and item), and a common ground sensitivity parameter $\\rho_i$ (which varies by age). Speaker optimality and semantic knowledge parameters are additionally constrained by the data from the Mutual Exclusivity task ($d^{Ex1}$; Expt. 1), via the same RSA model with no common ground $L'_1$;  common ground sensitivity parameters $\\rho_i$ are directly constrained by the data from the Common Ground experiment ($d^{Ex2}$; Expt. 2). Each of these RSA parameters is sampled from a linear or logistic regression model that track developmental change (with intercepts and slopes given by $\\beta_0$ and $\\beta_1$, respectively). Additionally, the semantic knowledge parameters for individual items $j$ are sampled from global vocabulary developmental parameters $\\mu^{\\theta}$ and $\\sigma^{\\theta}$ that characterize the mean and standard deviation of the intercepts and slopes for individual item trajectories."}

\usetikzlibrary{bayesnet}

\resizebox{1\textwidth}{!}{
  
\begin{tikzpicture}

\node[obs](data_comb){$d^{Ex3}_{ijk}$};
\node[obs, xshift=-3cm, yshift=0cm](data_me){$d^{Ex1}_{ij}$};
\node[obs, xshift=3cm,  yshift=0cm](data_cg){$d^{Ex2}_{i}$};

\node[det, above=of data_me](L1_me){$L_1'$};
\node[det, above=of data_comb](L1_comb){$L_1$};
\node[det, above=of L1_comb, xshift=-1.5cm, yshift=-0.5cm](RSA){$RSA$};

\edge{L1_me}{data_me};
\edge{L1_comb}{data_comb};
\edge{RSA}{L1_me};
\edge{RSA}{L1_comb};

% COMMON GROUND
\node[det, above=of data_cg, yshift=0.1cm](rho){$\rho_i$};
\node[latent, right=of rho, yshift=0.5cm](beta_rho_int){$\beta^{\rho}_0$};
\node[latent, right=of rho, yshift=-0.5cm](beta_rho_slope){$\beta^{\rho}_1$};

\edge{rho}{data_cg};
\edge{beta_rho_int}{rho};
\edge{beta_rho_slope}{rho};
\edge{rho}{L1_comb};

%% SPEAKER INFORMATIVITY

\node[det, left=of RSA, xshift=-1cm](alpha){$\alpha_i$};
\node[latent, left=of alpha, yshift=0.5cm](beta_alpha_int){$\beta^{\alpha}_0$};
\node[latent, left=of alpha, yshift=-0.5cm](beta_alpha_slope){$\beta^{\alpha}_1$};

%	\edge{alpha}{L1_me};
\edge{beta_alpha_int}{alpha};
\edge{beta_alpha_slope}{alpha};
\edge{alpha}{RSA};

%% SEMANTIC KNOWLEDGE model

	\node[det, above=of RSA, yshift=-0.25cm](theta){$\theta_{ij}$};
\node[latent, above=of theta, xshift=-1.25cm, yshift=-0.5cm](beta_theta_int){$\beta^{\theta}_{0, j}$};
\node[latent, above=of theta, xshift=1.25cm, yshift=-0.5cm](beta_theta_slope){$\beta^{\theta}_{1, j}$};

\node[latent, above=of beta_theta_int, xshift=-0.5cm](mu_theta_int){$\mu^{\theta}_{0}$};
\node[latent, above=of beta_theta_int, xshift=0.5cm](sigma_theta_int){$\sigma^{\theta}_{0}$};

\node[latent, above=of beta_theta_slope, xshift=-0.5cm](mu_theta_slope){$\mu^{\theta}_{1}$};
\node[latent, above=of beta_theta_slope, xshift=0.5cm](sigma_theta_slope){$\sigma^{\theta}_{1}$};

\edge{theta}{RSA};
%	\edge{theta}{L1_comb};
\edge{beta_theta_int}{theta};
\edge{beta_theta_slope}{theta};
\edge{mu_theta_int}{beta_theta_int};
\edge{sigma_theta_int}{beta_theta_int};
\edge{mu_theta_slope}{beta_theta_slope};
\edge{sigma_theta_slope}{beta_theta_slope};

\

\plate{plate_condition}{(data_comb)(L1_comb)}{$k \in \text{alignments}$};

	\plate{plate_items}{
%		(plate_data_me)
%		(plate_data_comb)
%		(plate_condition)
(plate_condition)
	(data_comb)
	(data_me)
	(L1_me)
	(L1_comb)
	(theta)
	(beta_theta_int)
	(beta_theta_slope)
}{$j \in \text{items}$}

	\plate{plate_data_comb}{
	(data_comb)
	(data_cg)
	(data_me)
	(plate_condition)
	(rho)
	(theta)
	(alpha)
	(L1_me)
	(L1_comb)
%		(plate_items)
	}{$i \in \text{2-to-4 year olds}$}



\node[draw, align=left, execute at begin node=\setlength{\baselineskip}{3ex}] at (7.5,5) { 
$\beta^\rho_0 ,\beta^\rho_1 \sim \text{Uniform}(-2,2)$ \\
 $\rho_i = \text{logistic}(\beta^\rho_0  + i \cdot \beta^\alpha_1)$ \\
$\beta^\alpha_0 \sim \text{Uniform}(-3,3)$ \\
$\beta^\alpha_1 \sim \text{Uniform}(-0,4)$ \\
 $\alpha_i = \beta^\alpha_0  + i \cdot \beta^\alpha_1$ \\
 $\mu^\theta_0 \sim \text{Uniform}(-3,3)$ \\
 $\mu^\theta_1 \sim \text{Uniform}(0,2)$ \\
 $\sigma^\theta_0 \sim \text{Uniform}(0,2)$ \\
 $\sigma^\theta_1 \sim \text{Uniform}(0,1)$ \\
 $\beta^\theta_0 \sim \text{Gaussian}(\mu^\theta_0, \mu^\sigma_0)$ \\
$\beta^\theta_1 \sim \text{Gaussian}(\mu^\theta_1, \mu^\sigma_1)$  \\
 $\theta_{ij} = \text{logistic}(\beta^\theta_{0,j}  + i \cdot \beta^\theta_{1,j})$
};

\node[draw, align=left, execute at begin node=\setlength{\baselineskip}{3ex}] at (8,0) {Integration model\\ $P_{L_1}(r \mid u; \{\rho_i, \alpha_i\, \theta_{ij}\})\propto P_{S_1}(u \mid r; \{\alpha_i, \theta_{ij}\}) \cdot P(r \mid \rho_i) $\\ 
$P_{S_1}(u \mid r; \{\alpha_i\, \theta_{ij}\})\propto P_{L_0}(r \mid u; \{\theta_{ij}\}) ^{\alpha_i} $\\
$P_{L_0}(r \mid u; \{\theta_{ij}\}) \propto \mathcal{L}(u, r \mid \theta_{ij})$
};


\end{tikzpicture}

}

```

## Implementation details

All Bayesian cognitive models were implemented in the probabilistic programming language `WebPPL` [@dippl]. The corresponding model code can be found in the associated online repository (file `webppl/prediction_model.wppl`). To generate model predictions, we estimated age sensitive parameter distributions for semantic knowledge (by familiar object), speaker informativeness and sensitivity to common ground and then passed them through the model in line with the different ways in which they can be combined and aligned (Figure \@ref(fig:bda)). The resulting predictions come in the form of distributions of developmental trajectories for each familiar object in the congruent and the incongruent condition.

We used the following prior distributions for model parameters. Intercept and slope for sensitivity to common ground: $\beta^\rho_0 ,\beta^\rho_1 \sim \text{Uniform}(-2,2)$. Speaker informativeness:  $\beta^\alpha_0 \sim \text{Uniform}(-3,3)$ for the intercept and $\beta^\alpha_1 \sim \text{Uniform}(-0,4)$ for the slope. We restricted the slope to be positive because negative values for speaker informativeness are conceptually implausible: We do not expect sensitivity to speaker informativeness to decrease across our age range. For the global semantic knowledge (vocabulary) parameters, we used $\mu^\theta_0 \sim \text{Uniform}(-3,3)$ for the intercept and $\mu^\theta_1 \sim \text{Uniform}(0,2)$ for the slope, because it is implausible to assume that semantic knowledge decreases with age. For the parameters capturing the variability the object specific trajectories around these overall parameters we used $\sigma^\theta_0 \sim \text{Uniform}(0,2)$ for the intercept and $\sigma^\theta_1 \sim \text{Uniform}(0,1)$ for the slope. Some choices regarding these prior distributions were made to ease model convergence. However, please note that all models considered used the same prior distributions.

## Prediction

In this section we evaluate different models in terms of how well they *predict* information integration. That is, in a situation in which we know the development of the (object specific) mutual exclusivity inference as well as the common ground inference, we look at each model's ability to predict what happens when the two are combined (combination data from Experiment 3). Investigating "pure" (or, *a priori*) prediction automatically excludes all models which include parameters that need to be fit to the combination data itself (e.g., a heuristic, non-integrating mixture model, described below). To generate *a priori* predictions, we independently estimated the model parameters for semantic knowledge and speaker informativeness based on Experiment 1 and the parameter for common ground sensitivity based on Experiment 2. 

To estimate the parameters for semantic knowledge and speaker informativeness, we adapted the model described above to a situation in which both objects (novel and familiar) have equal prior probability (i.e., no common ground information). We used the data from Experiment 1 to then infer the parameters. That is, we inferred the intercepts and slopes for speaker informativeness (linear regression) and semantic knowledge (logistic regression) that generated RSA model predictions to match the responses generated in Experiment 1. To estimate the parameters representing sensitivity to common ground, we used a simple logistic regression to infer which combination of intercept and slope would generate predictions that corresponded to the average proportion of correct responses measured in Experiment 2. Figure \@ref(fig:bda) visualizes how parameters were estimated.  

To estimate the parameter distributions, we collected samples from six independent MCMC chains, collecting 150,000 samples from each chain and removing the first 50,000 for burn-in. We excluded samples from one chain because it got stuck on a local maximum which resulted in parameter distributions that were substantially different from the other chains. To direclty access the model predictions see the file `model_comparison.Rmd` in the online repository. 

Next, we combined the parameters according to the four models described below. Note that the parameter distributions were the same for all models (see Figure \@ref(fig:fig4)) and that models only differed in terms of which parameters they included. The models described below are a full model (**integration model**) and three lesioned models, which selectively omit one type of information. The following model comparison therefore asks which types of information are necessary to make good predictions about how information is integrated. All models used age-specific parameters when the parameter was present. We do not compare models that make different assumptions about how information is integrated, since they require additional parameters specific to Experiment 3. We consider the question of alternative integration models in the [explanation](#explanation) section.

```{r}
# parameter distributions based on model 
item_params <- readRDS("../saves/item_params.rds")
global_params <- readRDS("../saves/global_params.rds")
item_sigma <- readRDS("../saves/item_sigma.rds")

# summaries
item_params_summary <- item_params %>%
  group_by(item, parameter)%>%
  summarise(mode = estimate_mode(value),
            uci = hdi_upper(value),
            lci = hdi_lower(value))

global_params_summary <- global_params %>%
  group_by (parameter,type)%>%
  summarise(mode = estimate_mode(value),
            uci = hdi_upper(value),
            lci = hdi_lower(value))

# selection object
select <- sample(1:length(unique(global_params$iteration)), 30)


# plot for semantic knowledge

sem_know_map <- item_params_summary%>%
  select(-uci,-lci)%>%
  spread(parameter, -item) %>%
  expand_grid(., age = unique(me_data$age)) %>%
  mutate(sem_know = plogis(intercept + slope * age)) %>%
  left_join(aoa_ratings) %>%
  ungroup()%>%
  mutate(item = fct_reorder(factor(item), mean_aoa))

plot_sem_know <- ggplot()+
  geom_line(data = sem_know_map, aes(x = age+2, y= sem_know, col = item, group = item),size = 1)+
  ylab("Semantic knowledge")+
  xlab("Age")+
  ylim(0,1)+
  theme_few()+
  scale_colour_viridis_d(name = "Object")

# plot or speaker optimality

speak_opt <- global_params%>%
  filter(parameter == "speaker_optimality")

speak_opt_line <- speak_opt%>%
  filter(iteration %in% select)%>%
  spread(type, value)%>%
  expand_grid(., age = unique(me_data$age))%>%
  mutate(y = intercept + slope * age)

speak_opt_map <- global_params_summary%>%
  ungroup()%>%
  filter(parameter == "speaker_optimality")%>%
  select(type, mode)%>%
  spread(type, mode)%>%
  expand_grid(., age = unique(me_data$age))%>%
  mutate(y = intercept + slope * age)

plot_speak_opt <- ggplot() +
  geom_line(data = speak_opt_line, aes(x=age+2,y = y, group = interaction(chain,iteration)), size = .2, alpha = .1)+
  geom_line(data = speak_opt_map, aes(x=age+2,y = y),size = 1)+
  labs(x="Age",y="Speaker informativeness")+
  theme_few() +
  ylim(0,10)+
    xlim(2,5)+
  guides(alpha = F, fill = F, col = F)

# Plot prior sensitivity

prior <- global_params%>%
  filter(parameter == "prior")

prior_line <- prior%>%
  filter(iteration %in% select)%>%
  spread(type, value)%>%
  expand_grid(., age = unique(me_data$age))%>%
  mutate(y = plogis(intercept + slope * age))

prior_map <- global_params_summary%>%
  ungroup()%>%
  filter(parameter == "prior")%>%
  select(type, mode)%>%
  spread(type, mode)%>%
  expand_grid(., age = unique(me_data$age))%>%
  mutate(y = plogis(intercept + slope * age))

plot_prior <- ggplot() +
  geom_line(data = prior_line, aes(x=age+2,y = y, group = interaction(chain,iteration)), size = .2, alpha = .1)+
  geom_line(data = prior_map, aes(x=age+2,y = y),size = 1)+
  labs(x="Age",y="Prior sensitivity")+
  theme_few() +
  ylim(0,1)+
  xlim(2,5)+
  guides(alpha = F, fill = F, col = F)

```

```{r fig4, include = T, fig.cap = "Developmental trajectories for model parameters based on the posterior distribution for (A) semantic knowlede, (B) speaker informativeness and (C) prior sensitivity. Solid lines in show the MAP estimate for each parameter. Lighter lines in (B) and (C) show 300 random draws from the posterior distributon to visualize uncertainty. (A) does not include these random draws for the sake of clarity.", fig.width=12, fig.height = 4}
ggarrange(plot_sem_know, plot_speak_opt, plot_prior , labels = c("A","B","C"), nrow = 1, widths = c(1.3,1,1))
```

### Models

#### Integration model

The **integration model** serves as the full model and takes in all available information. That is, it takes in object-specific semantic knowledge, speaker informativeness and common ground sensitivity and combines these components by way of the process described above. Figure \@ref(fig:fig5) visualizes the corresponding model predictions in comparison to the data from Experiment 3.

We compare this model to three alternative, "lesioned" models that lack certain components of the full integration model.

```{r fig5, include = T, cache = T, fig.cap = "Predicting information integration across development. Model predictions based on the integration model. Colored lines show developmental trajectories for each familiar object and condition based on 300 random draws from the model posterior distribution. Top row (blue) shows the congruent condition and the bottom row (red) shows the inconguent condition. Familiar objects are ordered based on their rated age of acquisition (left to right). Dashed black lines show smoothed conditional mean of the data with 95\\% CI (in grey). Light dots are individual data points.", fig.width=12, fig.height = 4}
# comb_data_binned <- comb_data%>%
#   group_by(subage, alignment, item)%>%
#   summarize(k = sum(correct), n = n())%>%
#   ungroup() %>%
#   mutate(a = 1 + k,
#          b = 1 + n - k,
#          data_mean = (a-1)/(a+b-2),
#          data_ci_lower  = qbeta(.025, a, b),
#          data_ci_upper = qbeta(.975, a, b),
#          age = factor(subage))%>%
#   select(-a,-b,-n,-k)%>%
#   left_join(aoa_ratings) %>%
#   ungroup()%>%
#   mutate(item = fct_reorder(factor(item), mean_aoa))
# 
# select_pred <- sample(1:20000, 60)
# 
# plot_prag_pred <- readRDS("../saves/model_pred_prag.rds")%>%
#   filter(iteration %in% select_pred)%>%
#   left_join(aoa_ratings) %>%
#   ungroup()%>%
#   mutate(item = fct_reorder(factor(item), mean_aoa))
# 
# 
#  saveRDS(plot_prag_pred, "../saves/plot_prag_pred.rds")

plot_prag_pred <- readRDS( "../saves/plot_prag_pred.rds")


ggplot(data = comb_data, aes(x = age_num, y = correct)) +
  geom_hline(yintercept = 0.5, lty=2)+
  geom_jitter(col = "black", height = .025, alpha = .1)+
  #geom_pointrange(data = comb_data_binned, aes(x = subage+.5, y = data_mean, ymin =data_ci_lower, ymax = data_ci_upper), stroke = 1, pch = 5)+
  #geom_line(data = comb_data_binned, aes(x = subage+.5, y = data_mean))+
  geom_line(data = plot_prag_pred, aes(x=age+2,y = pred, col = alignment, group = interaction(chain,iteration)), size = .2, alpha = .25)+
  geom_smooth(data = comb_data, aes(x = age_num, y = correct), col = "black", method = "glm", method.args = list(family = "binomial"), se = T, alpha = .4, lty = 2, size = 1)+
  labs(x="Age",y="Mutual Exclusivity effect")+
  facet_grid(alignment~item)+
  theme_few() +
  ylim(-0.05,1.05)+
  xlim(2,5)+
  guides(alpha = F, fill = F, col = F)+ 
  scale_colour_ptol(name = NULL)
```

#### No word-specific knowledge model

A marginally less-complex model than the full integration model uses the same model architecture, taking in speaker informativeness and common ground sensitivity, but omits semantic knowledge that is specific to the familiar objects (i.e., uses only general semantic knowledge). We described above that the parameters for semantic knowledge are fitted via a hierarchical regression (mixed effects) model. In this model, there is an overall developmental trajectory for semantic knowledge (main effect) and then there is object-specific variation around this trajectory (random effects). The **no word knowledge model** takes in the overall trajectory for semantic knowledge---represented by $\mu^\theta_0$ and $\mu^\theta_1$---but ignores object-specific variation. Formally, the semantic knowledge for each item is the same: $\theta_{i} = \mu^\theta_0 +  i \cdot \mu^\theta_1$. That is, the model assumes a listener whose mutual exclusivity inference does not vary depending on the particular familiar object but only depends on the age specific average semantic knowledge.   

\begin{equation}
P^{no\_wk}_{L_1}(r \mid u; \{\rho_i, \alpha_i\, \theta_{i}\})\propto P_{S_1}(u \mid r; \{\alpha_i, \theta_{i}\}) \cdot P(r \mid \rho_i) \\ 
(\#eq:noword)
\end{equation}

#### No common ground model

We consider a model that ignores common ground information, $\rho_i$. This model takes in object specific semantic knowledge and speaker informativeness but uses a prior distribution over objects that is constant across alignment conditions and uniform (e.g., [0.5, 0.5]). This model corresponds to a listener who only focuses on the mutual exclusivity inference and ignores the common ground manipulation. As a consequence, the listener does not differentiate between the two common ground alignment conditions.

\begin{equation}
P^{no\_cg}_{L_1}(r \mid u; \{\alpha_i\, \theta_{ij}\})\propto P_{S_1}(u \mid r; \{\alpha_i, \theta_{ij}\}) \\ 
(\#eq:nocg)
\end{equation}

#### No mutual exclusivity model

Finally, we consider a model that focuses only on common ground information and ignores the identity of the objects on the tables as well as any inferences their semantic knowledge of the familiar objects license. The predictions of this model correspond to the prior distribution over objects. 

\begin{equation}
P^{no\_me}_{L_1}(r \mid u; \{\rho_i\})\propto P(r \mid \rho_i) 
(\#eq:nome)
\end{equation}

### Model comparison

We compared the models mentioned above in two ways. First, we used correlations between model predictions and the data. For this analysis, we binned the model predictions and the data by age in years and by the type of familiar object. Figure \@ref(fig:fig6) visualizes the correlation between model predictions and the data for all models. The results shows a very high correlation between the predictions of the **integration model** and the data in all age groups indicating that the model accurately captures the variation in the data. Correlations for the **integration model** were also higher compared to the other models considered. The correlation increased from 2- to 3-year-olds but then again dropped for 4-year-olds. The mis-match for the oldest age group is probably a consequence of the model making very extreme predictions in the congruent condition. This results from the fact that 4-year-olds show very high performance both the mututal exclusivity and common ground tasks. When combined in the model, the two inferences amplify one another because we assume no cost of integration. We maintain no cost to integration because positing integration cost introduces a free parameter that could only be estimated based on the integration data of Experiment 3 itself (i.e., such a model would not make precise *a priori* predictions).

We additionally compared models based on the marginal likelihood of the data under each model -- the likelihood of the data averaging over ("marginalizing over") the prior distribution on parameters; the pair-wise ratio of marginal likelihoods for two models is known as the Bayes Factor (see file `model_comparison.Rmd` in the associated online repository). Bayes Factors quantify the quality of predictions of a model, averaging over the possible values of the parameters of the models (weighted by the prior probabilities of those parameter values); by averaging over the prior distribution on parameters, Bayes Factor implicitly take into account model complexity because models with more parameters will tend to have a broader prior distribution over parameters, which in effect, can water down the potential gains in predictive accuracy that a model with more parameters can achieve [@lee2014bayesian]. For this analysis, we treated age continuously. Table \@ref(tab:table5) lists the Bayes factors for the different model comparisons. The results show that the **integration model**, by far, outperformed all the other models. When comparing the lesioned models among each other, we see that models including the mutual exclusivity inference make better predictions compared to the **no mutual exclusivity model**.

Taken together, these analyses showed two things. First, the **integration model** makes accurate predictions about how mutual exclusivity and common ground inferences are integrated. It does so based on knowing the strength and development of each inference alone, and incorporating them into a structured probabilistic model of pragmatic reasoning. Second, models that omit one or more types of information (object specific word knowledge, speaker informativeness, common ground sensitivity) make appreciably worse predictions. This result exemplifies that children across the entire age range flexibly integrate all the available information. In the next section we ask investigate alternative formulations of the process of information integration.

```{r fig6, include = T,  fig.cap = "Predicting information integration. Correlations between model predictions and data binned by year, item and condition. Vertical and horizontal error bars show 95\\% HDI. Blue diamonds show congruent condition and red ones show the incongruent condition.", fig.width=12, fig.height = 8}

# cor_prag <- readRDS("../saves/model_pred_prag.rds")%>%
#   mutate(age = as.numeric(age) + min(comb_data$age_num),
#          age = cut(age,
#                       breaks = c(2,3,4,5),
#                       labels = c(2,3,4)))%>%
#   group_by(model,alignment, item, age)%>%
#   summarise(model_mean = estimate_mode(pred),
#             model_ci_lower = hdi_lower(pred),
#             model_ci_upper = hdi_upper(pred))
# 
# cor_global <- readRDS("../saves/model_pred_global.rds")%>%
#   mutate(age = as.numeric(age) + min(comb_data$age_num),
#          age = cut(age,
#                       breaks = c(2,3,4,5),
#                       labels = c(2,3,4)))%>%
#   group_by(model, alignment, item, age)%>%
#   summarise(model_mean = estimate_mode(pred),
#             model_ci_lower = hdi_lower(pred),
#             model_ci_upper = hdi_upper(pred))
# 
# cor_flat <- readRDS("../saves/model_pred_flat.rds")%>%
#   mutate(age = as.numeric(age) + min(comb_data$age_num),
#          age = cut(age,
#                       breaks = c(2,3,4,5),
#                       labels = c(2,3,4)))%>%
#   group_by(model, alignment, item, age)%>%
#   summarise(model_mean = estimate_mode(pred),
#             model_ci_lower = hdi_lower(pred),
#             model_ci_upper = hdi_upper(pred))
# 
# cor_prior <- readRDS("../saves/model_pred_prior.rds")%>%
#   mutate(age = as.numeric(age) + min(comb_data$age_num),
#          age = cut(age,
#                       breaks = c(2,3,4,5),
#                       labels = c(2,3,4)))%>%
#   group_by(model, alignment, item, age)%>%
#   summarise(model_mean = estimate_mode(pred),
#             model_ci_lower = hdi_lower(pred),
#             model_ci_upper = hdi_upper(pred))
# 
# cor_model_pred <- bind_rows(
#    cor_prag,
#    cor_global,
#    cor_flat,
#    cor_prior
# )
# 
# 
# plot_cor_model_pred <- cor_model_pred %>%
#   left_join(
#     bind_rows(
#        binnned_data%>%mutate(model = "integration"),
#        binnned_data%>%mutate(model = "no word knowledge"),
#        binnned_data%>%mutate(model = "no common ground"),
#        binnned_data%>%mutate(model = "no mutual exclusivity")
#       )
#   )%>%
  # mutate(age = fct_recode(age,
  #                         "2-year-olds" = "2",
  #                         "3-year-olds" = "3",
  #                         "4-year-olds" = "4"))
#
#saveRDS(plot_cor_model_pred, "../saves/corr_model_data_pred.rds")

plot_cor_model_pred <- readRDS( "../saves/corr_model_data_pred.rds")%>%
  mutate(model = factor(model, levels = c("integration", "no word knowledge", "no common ground", "no mutual exclusivity")))
 
ggplot(data = plot_cor_model_pred,aes(x = model_mean, y = data_mean, col = alignment)) +
  geom_abline(intercept = 0, slope = 1, lty = 2, alpha = 1, size = .5)+
  geom_errorbar(aes(ymin = data_ci_lower, ymax = data_ci_upper),width = 0,size = .5, alpha = .7)+
  geom_errorbarh(aes(xmin = model_ci_lower, xmax = model_ci_upper), height = 0,size = .5, alpha = .7)+
  geom_point(size = 1.5, stroke = 1, pch = 5)+
  coord_fixed()+
stat_cor(method = "pearson", label.x = 0.01, label.y = 0.99, aes(x = model_mean, y = data_mean, label = paste(..rr.label..)), inherit.aes = F, size = 3)+
  xlim(0,1)+ylim(0,1)+
  xlab("Model")+
  ylab("Data")+
  facet_grid(age~model)+
  theme_few() + 
  scale_colour_ptol(name ="Condition")
```

```{r table5}
model_comp_pred <- readRDS("../saves/pred_model_comparison.rds")%>%
  mutate(model = factor(model),
         `Model comparison` = fct_recode(model, 
                            "integration vs no word knowledge" = "prag_vs_global",
                            "integration vs no common ground" = "prag_vs_flat",
                            "integration vs no mutual exclusivity" = "prag_vs_prior",
                            "no word knowledge vs no mutual exclusivity" = "global_vs_flat",
                            "no word knowledge vs no common ground" = "global_vs_prior",
                            "no mutual exclusivity vs no common ground" = "flat_vs_prior"),
        `Bayes factor` = format(round(exp(logBF)), trim = T, justify = "right", scientific = F))%>%
  select(-logBF, -model)
  
  

knitr::kable(model_comp_pred, caption = "Model comparison using Bayes factors computed based on the marginal likelihood of each model given the data.", digits = 2, align = "l")
```

## Explanation

In this section we explore how to best explain information integration across development. We explore alternative ways to think about information integration. The **integration model** outlined above operates via Bayesian inference in that the prior probability of a referent (a consequence of the common ground manipulation) is updated via the likelihood of hearing the utterance heard from a speaker, which is used to derive the mutual exclusivity inference. In essence, this model is a multiplicative model because the posterior probability of each referent given the utterance is proportional to the product of the likelihood of a speaker saying that utterance and the prior probability of that referent. 

Information sources need not be integrated in a Bayesian manner as part of the same pragmatic reasoning architecture. Instead, the common ground and mutual exclusitivity inferences we consider could be computed separately and combined in a more heuristic fashion. A listener could integrate these two independent inferences in an additive manner, weighting the sources of information by some ratio $\phi$. $\phi$ is then a bias to prefer one type of inference relative to the other. We formalize this alternative hypothesis as a  **mixture model**.

The **integration** and **mixture** models have potentially different implications for developmental change.
The **integration model** assumes that the process by which information is integrated remains constant across development. What changes is children's sensitivity to different cues: semantic knowledge, their expectations about speaker informativeness, and their sensitivity to common ground. The **mixture model** alternatively posits that there is some bias or preference for one information source, and this bias could change across development. This **developmental mixture model**  makes the same assumptions about developmental change in sensitivities to individual information sources as the **integration model** but, in addition, assumes that the way that the mutual exclusivity and the common ground inference are combined changes over time. This model is structurally identical to the **mixture model** but the mixture parameter $\phi$ is a function of age, which we model via a logistic-linear model: $\phi_i = \text{logistic}(\beta^\phi_0 + i \cdot \beta^\phi_1)$, whose parameters we infer via Bayesian inference. 

In this section, we make use of all the available data to arbitrate between these alternative models (a fully Bayesian analysis). As before, Experiments 1 and 2 directly constrain the parameters governing semantic knowledge, speaker informativeness, and the prior distribution over referents (via common ground; Expt. 2). Now, in addition, we incorporate the data from Experiment 3 to additionally constrain these parameters as well as inform the mixture parameter for the mixture models (see Figure \@ref(fig:bda)).

### Integration model 

```{r}
item_params_exp <- readRDS("../saves/item_params_fb.rds")
global_params_exp <- readRDS("../saves/global_params_fb.rds")
item_sigma_exp <- readRDS("../saves/item_sigma_fb.rds")
```

The **integration model** in this section differs from the integration model in the [prediction section](#prediction) only in that the parameter distributions are now additionally informed by the data from Experiment 3. Figure \@ref(fig:figa1) - \@ref(fig:figa3) in the Appendix show how the parameter distributions differ between the prediction and the explanation version of the **integration model**. Semantic knowledge and speaker informativeness have similar posterior distributions when taking into account all the data compared to when estimating these parameters only based on Experiment 1 and 2. In contrast, the intercept for common ground sensitivity is estimated to be larger and the slope shallower after taking into account Experiment 3 data. That is, our best guess for common ground sensitivity after taking into account the data from Experiment 3 is that younger children are more sensitive to the common ground manipulation and there is less developmental change. The code to run the model can be found in the associated online repository (file: `webppl/explanation_integration_model.wppl`). Figure \@ref(fig:fig9) shows model predictions for the **integration model** in comparison to the data from Experiment 3.

```{r fig9, include = T, cache = T,  fig.cap = "Explaining information integration across development. Model predictions based on the integration model. Colored lines show developmental trajectories for each familiar object and condition based on 300 random draws from the model posterior distribution. Top row (blue) shows the congruent condition and the bottom row (red) shows the inconguent condition. Familiar objects are ordered based on their rated age of acquisition (left o right). Dashed black lines show smoothed conditional mean of the data with 95\\% CI (in grey). Light dots are individual data points.", fig.width=12, fig.height = 4}


# select_exp <- sample(1:20000, 50)
# 
# plot_prag_exp <- readRDS("../saves/model_pred_prag_fb.rds")%>%
#   filter(iteration %in% select_pred)%>%
#   left_join(aoa_ratings) %>%
#   ungroup()%>%
#   mutate(item = fct_reorder(factor(item), mean_aoa))
# 
# 
# saveRDS(plot_prag_exp, "../saves/plot_prag_exp.rds")

plot_prag_exp<- readRDS( "../saves/plot_prag_exp.rds")


ggplot(data = comb_data, aes(x = age_num, y = correct)) +
  geom_hline(yintercept = 0.5, lty=2)+
  geom_jitter(col = "black", height = .025, alpha = .1)+
  #geom_pointrange(data = comb_data_binned, aes(x = subage+.5, y = data_mean, ymin =data_ci_lower, ymax = data_ci_upper), stroke = 1, pch = 5)+
  #geom_line(data = comb_data_binned, aes(x = subage+.5, y = data_mean))+
  geom_line(data = plot_prag_exp, aes(x=age+2,y = pred, col = alignment, group = interaction(chain,iteration)), size = .2, alpha = .25)+
  geom_smooth(data = comb_data, aes(x = age_num, y = correct), col = "black", method = "glm", method.args = list(family = "binomial"), se = T, alpha = .4, lty = 2, size = 1)+
  labs(x="Age",y="Mutual Exclusivity effect")+
  facet_grid(alignment~item)+
  theme_few() +
  ylim(-0.05,1.05)+
  xlim(2,5)+
  guides(alpha = F, fill = F, col = F)+ 
  scale_colour_ptol(name = NULL)
```

### Mixture model

In the **mixture model** the two inferences (common ground and mutual exclusivity) are computed in the same way as in in the **integration model**. Subsequently, they are weighted by the mixture parameter $\phi$:

\begin{equation}
P^{mixture}_{L_1}(r \mid u; \{\phi, \rho_i, \alpha_i, \theta_{ij} \}) = \phi \cdot P_{ME}(r \mid u; \{\alpha_i, \theta_{ij}\})  + (1-\phi) \cdot P(r \mid \rho_i)
(\#eq:mix1)
\end{equation}

\begin{equation}
P_{ME}(r \mid u; \{\alpha_i, \theta_{ij}\}) \propto P_{S_1}(u \mid r; \{\alpha_i, \theta_{ij}\})
(\#eq:mix2)
\end{equation}

where $P_{ME}(r \mid u; \{\alpha_i, \theta_{ij}\})$ represents a mutual-exclusivity inference from a listener with a uniform prior on referents. $P_{S_1}(u \mid r; \{\alpha_i, \theta_{ij}\}$ is the same as in Eq. \@ref(eq:rsafull2) above.

To estimate $\phi$ as well as the other parameters, we make use of all the available data. The model code can be found in the associated online repository (file: `webppl/explanation_mixture_model.wppl`). The posterior distribution for the mixture parameter $\phi$ is shown in figure \@ref(fig:fig10)A. It suggests that the mutual exclusivity inference is weighted as slightly more important compared to the common ground inference.

```{r}
item_params_mixture <- readRDS("../saves/item_params_mm.rds")

global_params_mixture <- readRDS("../saves/global_params_mm.rds")

mixture_parameter <- readRDS("../saves/mixture_mm.rds")
```

```{r}
plot_mixture <- ggplot(mixture_parameter, aes(x = p_informative))+
  geom_density(alpha = 0.8, adjust = 2)+
  xlab("Proportion mutual exclusivity component")+
  xlim(0,1)+
  theme_few()

```

### Developmental mixture model

For this model, we make the mixture parameter $\phi$ as a logistic-linear function of age-- $\phi_i = \text{logistic}(\beta^\phi_0 + i \cdot \beta^\phi_1)$ --- and estimate the intercept and slope that yield the best model predictions compared to the data from Experiment 3. The **developmental mixture model** is then:

\begin{equation}
P^{dev\_mixture}_{L_1}(r \mid u; \{\phi_i, \rho_i, \alpha_i, \theta_{ij} \}) = \phi_i \cdot P_{ME}(r \mid u; \{\alpha_i, \theta_{ij}\})  + (1-\phi_i) \cdot P(r \mid \rho_i)
(\#eq:devmix)
\end{equation}

The model code can be found in the associated online repository (file: `webppl/explanation_mixture_model.wppl`). Figure \@ref(fig:fig10)B visualizes the developmental trajectory of the mixture parameter. Based on this model, the common ground inference seems to decrease in importance compared to the mutual exclusivity inference with age.

```{r}
item_params_dev_mixture <- readRDS("../saves/item_params_dmm.rds")

global_params_dev_mixture <- readRDS("../saves/global_params_dmm.rds")

developmental_mixture_parameter <- readRDS("../saves/mixture_dmm.rds")
```

```{r}
select_dev_mix <- sample(1:20000, 50)

plot_mixture_line <- developmental_mixture_parameter%>%
  filter(iteration %in% select_dev_mix) %>%
  spread(type, value) %>%
  expand_grid(.,age = unique(comb_data$age)) %>%
  mutate(mixture = plogis(intercept + slope * age))

plot_dev_mixture <- ggplot() +
  geom_line(data = plot_mixture_line, aes(x=age+2,y = mixture, group = interaction(chain,iteration)),size = .2, alpha = .1)+
  labs(x="Age",y="Proportion mutual exclusivity component")+
  theme_few() +
  ylim(-0.05,1.05)+
  xlim(2,5)+
  guides(alpha = F, fill = F)

```

```{r fig10, include = T, fig.cap = "Mixture component for the mixture model (A) and the developmental mixture model (B). (A) shows the posterior distribution of the mixture component and (B) shows developmental trajectories for the mixture component based on 300 random draws from the posterior distribution for intercept and slope.", fig.width=10, fig.height = 4, }
ggarrange(plot_mixture, plot_dev_mixture,  labels = c("A","B"), nrow = 1)
```

### Model comparison

As before, we compared models based on correlations and Bayes factors. Figure \@ref(fig:fig11) shows correlations between model predictions and the data, each binned by year and by object. Even though both mixture models have more free parameters then the **integration model**, the **integration model** shows the highest correlation in all age groups, though model predictions and data are closely aligned for all models. Next we directly compared models based using Bayes factors (see Table \@ref(tab:table6)). We also included the prediction **integration model** into this analysis.

Perhaps unsurprisingly, we see that informing the parameters for semantic knowledge, speaker informativeness and common ground sensitivity by the data from Experiment 3 greatly improves the model fit (comparison: integration (explanation) vs integration (prediction)). We also see that the explanation **integration model** provides, by far, the best fit to the data compared to the two **mixture models**, even though the integration model has fewer free parameters than the mixture model. Interestingly, the prediction **integration model** also had a better fit, even though its parameters were not constrained by the data from Experiment 3. When comparing the two **mixture models** directly, we see that an age sensitive mixture parameter did not result in a substantially better fit, providing additional evidence that the integration process itself is not changing across development.

This analysis shows that the inference and integration processes described by the **integration model** accurately capture the data and also explain information integration better compared to the additive **mixture models**. As a consequence, we may say that instead of being biased towards one type of inference, children are rationally integrating all the information sources available. 

```{r fig11, include = T,  fig.cap = "Explaining information integration. Correlations between model predictions and data binned by year, item and condition. Vertical and horizontal error bars show 95\\% HDI. Blue diamonds show congruent condition and red ones show the incongruent condition.", fig.width=12, fig.height = 8}

# cor_prag_exp <- readRDS("../saves/model_pred_prag_fb.rds")%>%
#   mutate(age = as.numeric(age) + min(comb_data$age_num),
#          age = cut(age,
#                       breaks = c(2,3,4,5),
#                       labels = c(2,3,4)))%>%
#   group_by(model,alignment, item, age)%>%
#   summarise(model_mean = estimate_mode(pred),
#             model_ci_lower = hdi_lower(pred),
#             model_ci_upper = hdi_upper(pred))
# 
# cor_mix_exp <- readRDS("../saves/model_pred_mm.rds")%>%
#   mutate(age = as.numeric(age) + min(comb_data$age_num),
#          age = cut(age,
#                       breaks = c(2,3,4,5),
#                       labels = c(2,3,4)))%>%
#   group_by(model, alignment, item, age)%>%
#   summarise(model_mean = estimate_mode(pred),
#             model_ci_lower = hdi_lower(pred),
#             model_ci_upper = hdi_upper(pred))
# 
# cor_dev_mix_exp <- readRDS("../saves/model_pred_dmm.rds")%>%
#   mutate(age = as.numeric(age) + min(comb_data$age_num),
#          age = cut(age,
#                       breaks = c(2,3,4,5),
#                       labels = c(2,3,4)))%>%
#   group_by(model, alignment, item, age)%>%
#   summarise(model_mean = estimate_mode(pred),
#             model_ci_lower = hdi_lower(pred),
#             model_ci_upper = hdi_upper(pred))
# 
# 
# cor_model_exp <- bind_rows(
#    cor_prag_exp%>%ungroup()%>%mutate(model = "integration"),
#    cor_mix_exp%>%ungroup()%>%mutate(model = "mixture"),
#    cor_dev_mix_exp%>%ungroup()%>%mutate(model = "developmental mixture")
# )
# 
# 
# plot_cor_model_exp <- cor_model_exp %>%
#   left_join(
#     bind_rows(
#        comb_data_binned%>%mutate(model = "integration"),
#        comb_data_binned%>%mutate(model = "mixture"),
#        comb_data_binned%>%mutate(model = "developmental mixture")
#       )
#   )%>%
#   mutate(age = fct_recode(age,
#                           "2-year-olds" = "2",
#                           "3-year-olds" = "3",
#                           "4-year-olds" = "4"))
# 
# saveRDS(plot_cor_model_exp, "../saves/corr_model_data_exp.rds")

plot_cor_model_exp <- readRDS( "../saves/corr_model_data_exp.rds")%>%
  mutate(model = factor(model, levels = c("integration", "mixture", "developmental mixture")))
 
ggplot(data = plot_cor_model_exp,aes(x = model_mean, y = data_mean, col = alignment)) +
  geom_abline(intercept = 0, slope = 1, lty = 2, alpha = 1, size = .5)+
  geom_errorbar(aes(ymin = data_ci_lower, ymax = data_ci_upper),width = 0,size = .5, alpha = .7)+
  geom_errorbarh(aes(xmin = model_ci_lower, xmax = model_ci_upper), height = 0,size = .5, alpha = .7)+
  geom_point(size = 1.5, stroke = 1, pch = 5)+
  coord_fixed()+
stat_cor(method = "pearson", label.x = 0.01, label.y = 0.99, aes(x = model_mean, y = data_mean, label = paste(..rr.label..)), inherit.aes = F, size = 3)+
  xlim(0,1)+ylim(0,1)+
  xlab("Model")+
  ylab("Data")+
  facet_grid(age~model)+
  theme_few() + 
  scale_colour_ptol(name ="Condition")
```

```{r table6}
model_comp_pred <- readRDS("../saves/expl_model_comparison.rds")%>%
  mutate(model = factor(model),
         `Model comparison` = fct_recode(model, 
                            "integration (explanation) vs integration (prediction)" = "fb_vs_free",
                            "integration (explanation) vs mixture" = "fb_vs_mixture",
                            "integration (prediction) vs mixture" = "free_vs_mixture",
                            "integration (explanation) vs developmental mixture" = "fb_vs_dev_mixture",
                            "integration (prediction) vs developmental mixture" = "free_vs_dev_mixture",
                            "developmental mixture vs mixture" = "dev_mixture_vs_mixture"),
        `Bayes factor` = format(round(exp(logBF)), trim = T, justify = "right", scientific = F))%>%
  select(-logBF, -model)
  
  

knitr::kable(model_comp_pred, caption = "Model comparison using Bayes factors computed based on the marginal likelihood of each model given the data.", digits = 2, align = "l")
```

# Summary

Here we studied how 2 to 5 year old children integrate semantic and pragmatic information during word learning. In three experiments, we first showed that children make a mutual exclusivity inference and that this inference varied depending on children's familiarity with the objects involved (Experiment 1). Next, we showed that children make common ground inferences based on their interactions with a speaker (Experiment 2). When the two inferences were combined, we found that children were sensitive to the way in which they were aligned (Experiment 3). 

We then introduced a computational model to investigate the process by which children integrated the inferences in Experiment 3. As a start, we described mutual exclusivity as a pragmatic inference, which takes in children's emerging semantic knowledge and their expectations about how informative a speaker is. The **integration model** assumes that this inference is then flexibly integrated with children's developing sensitivity to common ground.

Next, we tested the predictive power of this model. That is, we asked how well the model would predict the data of Experiment 3, when only knowing the developmental trajectories for mutual exclusivity (based on Experiment 1) and common ground (Experiment 2). We found a very close alignment of the model predictions and the data across the entire age range. Furthermore, the **integration model** provided a better fit to the data compared to a number of lesioned models, which selectively omitted one type of information. These results suggest that children flexibly integrate all available information. 

In the final section, we studied which process best explained children's information integration. We compared the **integration model** to a **mixture model** which assumed that children are biased towards one type of inference, and a **developmental mixture model** that assumed that the bias could change across development. We found that the **integration model** better explained the data compared to both of these mixture models, even though the mixture models had more free parameters. In sum, we found that children's integration of semantic and pragmatic information during word learning is best described as a form of Bayesian social inference. 

# Appendix: Model parameters 

In the following, we visualize the model parameters for semantic knowledge, speaker informativeness and common ground sensitivity. Please note that the alternative lesion models presented in the prediction section used the same parameter distributions as the prediction **integration model**. 

## Semantic knowledge

### Intercept

```{r}
item_comp <- bind_rows(
  item_params_exp %>% mutate(model = "integration (explanation)"),
  item_params %>% mutate(model = "integration (prediction)"),
  item_params_mixture %>% mutate(model = "mixture"),
  item_params_dev_mixture %>% mutate(model = "developmental mixture")
)%>%
  mutate(model = factor(model, levels = c("integration (prediction)","integration (explanation)", "mixture","developmental mixture")))

```

```{r figa1, include = T, cache=T,  fig.cap = "Posterior distribution of intercept term for semantic knowledge for each object by model.", fig.width=12, fig.height = 6}

item_comp_int <- item_comp %>%
  filter(parameter == "intercept")

ggplot(item_comp_int, aes(x = value, fill = model, col = model))+
  geom_density(alpha = 0.8, adjust = 2)+
  xlab("value")+
  facet_wrap( ~ item, nrow = 2, scales = 'free')+
  theme_few()+
  xlim(-10,5)+
  theme(legend.position = "bottom")+
  scale_fill_ptol(name = "Model")+
  scale_color_ptol(name = "Model")
```

### Slope

```{r figa2, include = T, cache=T,  fig.cap = "Posterior distribution of slope term for semantic knowledge for each object by model.", fig.width=12, fig.height = 6}

item_comp_slope <- item_comp %>%
  filter(parameter == "slope")

ggplot(item_comp_slope, aes(x = value, fill = model, col = model))+
  geom_density(alpha = 0.8, adjust = 2)+
  xlab("value")+
  facet_wrap( ~ item, nrow = 2, scales = 'free_y')+
  xlim(-1,4)+
  theme_few()+
  theme(legend.position = "bottom")+
  scale_fill_ptol(name = "Model")+
  scale_color_ptol(name = "Model")
```

## Speaker informativeness and common ground sensitivity

```{r figa3, include = T, cache=T, fig.cap = "Posterior distribution of slope and intercept terms for speaker informativeness and sensitivity to common ground by model.", fig.width=8, fig.height = 6}

global_comp <- bind_rows(
  global_params_exp %>% mutate(model = "integration (explanation)"),
  global_params %>% mutate(model = "integration (prediction)"),
  global_params_mixture %>% mutate(model = "mixture"),
  global_params_dev_mixture %>% mutate(model = "developmental mixture")
)%>%
  filter(parameter !="global_sem")%>%
  mutate(parameter = fct_recode(parameter, 
                               "common ground sensitivity" = "prior",
                               "speaker informativeness" = "speaker_optimality"))%>%
  mutate(model = factor(model, levels = c("integration (prediction)","integration (explanation)", "mixture","developmental mixture")))

ggplot(global_comp, aes(x = value, fill = model, col = model))+
  geom_density(alpha = 0.8, adjust = 2)+
  xlab("value")+
  facet_grid(type ~ parameter, scales = 'free')+
  theme_few()+
  theme(legend.position = "right")+
  scale_fill_ptol(name = "Model")+
  scale_color_ptol(name = "Model")
```
