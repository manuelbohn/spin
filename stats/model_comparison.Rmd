---
title: "Model Comparison"
output: html_document
---

```{r}
library(tidyverse)
library(readxl)
library(matrixStats)
library(data.table)


estimate_mode <- function(s) {
  d <- density(s)
  return(d$x[which.max(d$y)])
}


hdi_upper<- function(s){
  m <- HPDinterval(mcmc(s))
  return(m["var1","upper"])
}

hdi_lower<- function(s){
  m <- HPDinterval(mcmc(s))
  return(m["var1","lower"])
}
```
# Data 

```{r}
data_comb_pre <- read_csv("../data/combination.csv") 

aoa_ratings_all <- read_xlsx(path = "../data/words_aoa_ratings.xlsx", sheet = 1)

aoa_ratings <- aoa_ratings_all %>%
  filter(Word %in% data_comb_pre$item )%>%
  mutate(mean_aoa = as.numeric(Rating.Mean),
         item = Word)%>%
  select(item,mean_aoa)

data_comb <- data_comb_pre%>%
  left_join(aoa_ratings)%>%
  ungroup()%>%
  mutate(item = fct_reorder(factor(item), mean_aoa), 
         source = "Data")

d_model_comp <- data_comb%>%
  select(-age)%>%
  mutate(age = round(age_month,2),
         item = as.character(item))%>%
  select(alignment, item, age, correct)

```

# Model comparison

## Dummy example for MH

```{r}
# Model prediction files are very large - can't put them on github as is 
# files below contain the two iterations for each model (1286 & 7185)

# load model predicitons
test_prag <- readRDS("../saves/test_prag.rds")

test_global <- readRDS("../saves/test_global.rds")

test_flat <- readRDS("../saves/test_flat.rds")


bind_rows(
  test_prag, 
  test_global, 
  test_flat
)%>%
  spread(model, pred)%>%
  right_join(d_model_comp)%>%
  mutate(log_like_prag = log(ifelse(correct == 1, pragmatic, 1 - pragmatic)),
         log_like_global = log(ifelse(correct == 1, global, 1 - global)),
         log_like_flat = log(ifelse(correct == 1, flat, 1 - flat)))%>%
  mutate(prag_vs_global = log_like_prag - log_like_global, # subtract likelihood for each predictions and model
         prag_vs_flat= log_like_prag - log_like_flat,
         global_vs_flat = log_like_global - log_like_flat) %>%
  summarise(prag_vs_global = sum(prag_vs_global), # sum up likelihood difference to get log Bayes factor
            prag_vs_flat = sum(prag_vs_flat),
            global_vs_flat = sum(global_vs_flat))%>%
  gather(model, logBF)


```




