---
title: "SPIN Novelty Data"
output: html_document
---

```{r setup, include= FALSE}
knitr::opts_chunk$set(echo = FALSE, message = F, warning = F)
###
library(tidyverse)
library(knitr)
library(langcog)
library(ggthemes)
library(jsonlite)
library(readxl)
library(brms)
library(here)
#library(brmstools)
library(ggpubr)
library(rwebppl)

# import spin data

files <- dir("~/Work/Spin/raw_data/kids/novelty/")

raw_data <- data_frame()
for (f in files) {
  jf <- paste("~/Work/Spin/raw_data/kids/novelty/",f,sep="")
  jd <- jsonlite::fromJSON(paste(readLines(jf), collapse=""))
  date <- str_sub(jf,46,str_length(jf)-11)
  id <- as_data_frame(jd$data$data) %>% mutate(test_date = date)
  raw_data <- bind_rows(raw_data, id)
}


length(unique(raw_data$subid))

d_raw <-raw_data %>%
  mutate(test_date = as.Date(test_date),
         subid = ifelse(subid =="190422_6_nov,","190422_6_nov",subid),
         subage = ifelse(subid =="190422_2_nov","4",subage))


log <- read_excel("../../SPIN-subject_log.xlsx", 1)%>%
  filter(Condition == "nov")%>%
  mutate(dob = as.character(dob),
         dob = ifelse(subid =="190502_9_nov","2016-10-08",dob),
         dob = as.Date(dob))%>%
  select(subid,experimenter,keep_drop,sex,dob)

d_raw%>%
  group_by(subid)%>%
  summarise(n())%>%
  filter(!(subid %in% unique(log$subid)))


d_spin <- left_join(d_raw,log, by = "subid")%>%
  filter(keep_drop == "keep",
         trial != "train1", trial != "train2")%>%
  mutate(age_num = lubridate::time_length(difftime(test_date,dob), "years"),
         age_num_month = lubridate::time_length(difftime(test_date,dob), "month"),
         age_num_month = round(age_num_month)/12,
         age_month = age_num_month - min(age_num_month),
         check_age = ifelse(substr(age_num,1,1) == subage, T, F),
         experiment = condition)%>%
  mutate(age = age_num - min(age_num))%>%
  select(-pick_src, -test_date, -experimenter, - keep_drop, -dob, -sex, -check_age, - condition, -rt)
# 
# 
# ## import mcc data
# 
# files <- dir("~/Work/MCC/git-mcc/kids_novel_data/round2/")
# 
# raw_data_mcc <- data_frame()
# for (f in files) {
#   jf <- paste("~/Work/MCC/git-mcc/kids_novel_data/round2/",f,sep="")
#   jd <- jsonlite::fromJSON(paste(readLines(jf), collapse=""))
#   date <- str_sub(jf,51,str_length(jf)-11)
#   id <- as_data_frame(jd$data$data) %>% mutate(test_date = date)
#   raw_data_mcc <- bind_rows(raw_data_mcc, id)
# }
# 
# d_raw_mcc <-raw_data_mcc %>%
#   mutate(subage = ifelse(subid =="180810_14_nov","2",subage),
#          test_date = as.Date(test_date))
# 
# 
# log_mcc <- read_excel("~/Work/MCC/git-mcc/MCC-subject_log.xlsx", 1)%>%
#   filter(Condition == "nov")%>%
#   mutate(dob = as.numeric(dob),
#          dob = as.Date(dob,origin = "1899-12-30"))%>%
#   select(subid,experimenter,keep_drop,sex,dob)
# 
# 
# d_mcc <- left_join(d_raw_mcc,log_mcc, by = "subid")%>%
#   filter(keep_drop == "keep")%>%
#   mutate(age_num = lubridate::time_length(difftime(test_date,dob), "years"),
#          check_age = ifelse(substr(age_num,1,1) == subage, T, F),
#          leftObject = leftFruit,
#          rightObject = rightFruit,
#          pick = str_sub(pick,72,str_length(pick)-4),
#          agent = ifelse(speakerChange == "false", agent,altAgent),
#          experiment = "dis_novelty_mcc")%>%
#   filter(speakerChange == "false", trial != "train")%>%
#   select(-speakerChange,-altAgent,-leftFruit,-rightFruit)
# 
# 
# # join datasets
# 
# d <- bind_rows(d_spin, d_mcc)
# 
write_csv(d_spin, "../data/novelty.csv")

write_json(d_spin, "../data/novelty.json")
#write_csv(d, "../data/child_novelty.csv")

d_spin <- read_csv("../data/novelty.csv")%>%
  mutate(subage = factor(subage))


```

Main question: Do SPIN and MCC datasets differ?

# Participants

* dis_novelty_mcc = same speaker condition from MCC data collection
* n = number of subjects
* data_points = number of data points across subjects 

```{r sanity checks, echo = FALSE, warning = FALSE, message = FALSE}




## sanity checks
d_spin %>%
  group_by(experiment,subage) %>%
  summarise(n = length(unique(subid)),
            data_points = n())%>%
  kable()

```

# Plots

## Plot by age bin

```{r}
p1 <- d %>%
  group_by(experiment,subage, subid) %>%
  summarise(correct = mean(correct)) 

p2 <- p1 %>%
  multi_boot_standard(col = "correct")


ggplot() +
  geom_point(data = p1, aes(x = subage, y = correct, col = experiment, alpha = .2), position = position_jitterdodge(dodge.width = .6, jitter.width = .2, jitter.height = .05))+
  geom_pointrange(data = p2, aes(x = subage, y = mean, col = experiment, ymin = ci_lower, ymax = ci_upper),size = .8, position = position_dodge(width = .5))+
  geom_hline(yintercept = 0.5, lty=2)+
  labs(x="Age",y="Proportion Correct")+
  theme_few() +
  ylim(-0.05,1.05)+
  guides(alpha = F)+
  scale_color_solarized()

```

## Plot by age continuous

```{r plot by numerical age}
p5 <- d_spin %>%
  group_by(age_num,experiment, subid) %>%
  summarise(correct = mean(correct)) 

ggplot(data = p5, aes(x = age_num, y = correct, col = experiment)) +
  geom_smooth(data = d_spin, aes(x = age_num, y = correct),method = "glm", method.args = list(family = "binomial"), se = T, alpha = .3)+
  geom_jitter( alpha = .5, height = 0.01)+
  geom_hline(yintercept = 0.5, lty=2)+
  labs(x="Age",y="Proportion novel item chosen")+
  theme_few() +
  ylim(-0.05,1.05)+
  guides(alpha = F, col = F)+ 
  #theme(axis.text.x=element_blank(),axis.ticks.x=element_blank())+
  scale_colour_solarized()


ggsave("../graphs/novelty.png", width = , height = 4, scale = 1.2)
```

# SPIN GLMM

```{r}
spin_model_data <- d_spin%>%
  mutate(age_num = age_num-min(age_num))

spin_bm <- brm(correct ~ age_num + (1 | subid) + (age_num | agent), 
          data = spin_model_data, family = bernoulli(),
          control = list(adapt_delta = 0.95),
          sample_prior = F,
          save_all_pars = TRUE,
          iter = 2000)

summary(spin_bm)
```


# Comparison with MCC Data

## Model 

1. bm_full_1: correct ~ age_num * experiment + (1 | subid) + (age_num * experiment | agent)

2. bm_full_2: correct ~ age_num * experiment + (1 | subid) + (age_num | agent)

3. bm_null_1: correct ~ age_num + (1 | subid) + (age_num * experiment | agent)

4. bm_null_2: correct ~ age_num + (1 | subid) + (age_num | agent)

* experiment = SPIN or MCC
* subid = subject id 
* agent = animal making the request (item effect)
* age_num = age (numeric)

```{r, include = F, cache = T}

model_data <- d%>%
  mutate(age_num = scale(age_num, center = TRUE, scale = TRUE))


bm_full_1 <- brm(correct ~ age_num * experiment + (1 | subid) + (age_num * experiment | agent), 
          data = model_data, family = bernoulli(),
          control = list(adapt_delta = 0.95),
          sample_prior = F,
          save_all_pars = TRUE,
          iter = 2000)

bm_full_2 <- brm(correct ~ age_num * experiment + (1 | subid) + (age_num | agent), 
          data = model_data, family = bernoulli(),
          control = list(adapt_delta = 0.95),
          sample_prior = F,
          save_all_pars = TRUE,
          iter = 2000)

bm_null_1 <- brm(correct ~ age_num + (1 | subid) + (age_num * experiment | agent), 
          data = model_data, family = bernoulli(),
          control = list(adapt_delta = 0.99),
          sample_prior = F,
          save_all_pars = TRUE,
          iter = 2000)

bm_null_2 <- brm(correct ~ age_num + (1 | subid) + (age_num | agent), 
          data = model_data, family = bernoulli(),
          control = list(adapt_delta = 0.99),
          sample_prior = F,
          save_all_pars = TRUE,
          iter = 2000)


waic <- brms::waic(bm_full_1, bm_full_2,bm_null_1,bm_null_2, compare = F)

weights <- model_weights(bm_full_1, bm_full_2,bm_null_1,bm_null_2, weights = "waic")

bf_full_2_null_1 <- brms::bayes_factor(bm_full_2, bm_null_1, log = F, maxiter = 5000)
bf_full_2_full_1 <- brms::bayes_factor(bm_full_2, bm_full_1, log = F, maxiter = 5000)
bf_full_2_null_2 <- brms::bayes_factor(bm_full_2, bm_null_2, log = F, maxiter = 5000)
```

## Model comparison

* BF_full_2 = Bayes Factor compared to bm_full_2, the "winning" model in the model comparison.

```{r}
data_frame(
  model = c("bm_full_1","bm_full_2","bm_null_1","bm_null_2"),
  WAIC = c(waic$loo$bm_full_1$estimates[3,1],
           waic$loo$bm_full_2$estimates[3,1],
           waic$loo$bm_null_1$estimates[3,1],
           waic$loo$bm_null_2$estimates[3,1]),
  SE = c(waic$loo$bm_full_1$estimates[3,2],
           waic$loo$bm_full_2$estimates[3,2],
           waic$loo$bm_null_1$estimates[3,2],
           waic$loo$bm_null_2$estimates[3,2]),
  waic_weight = c(weights[1],weights[2],weights[3],weights[4]),
  BF_full_2 = c(round(bf_full_2_full_1$bf,0),"-",round(bf_full_2_null_1$bf,0),round(bf_full_2_null_2$bf,0)))%>%
  mutate_if(is.numeric, round, 2)%>%
  kable()
```

Models with experiment as predictor provide better fit. This suggests that we should not combine the two datasets.

## Summary for "winning" model

```{r}
fixef(bm_full_2)%>%
  kable(digits = 2)
```

Estimate for interaction is relaibly different from 0, suggesting again that data sets are not the same. 

## Estiamte plots for "winning" model 

```{r}
plot(bm_full_2)
```





