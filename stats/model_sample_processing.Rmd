---
title: "Model Samples Processing"
author: "M. Bohn"
date: "18 11 2019"
output: html_document
---

```{r}
library(tidyverse)
library(rwebppl)
library(brms)
library(coda)
library(ggthemes)
library(readxl)
library(ggpubr)
library(stringr)
library(matrixStats)
library(data.table)
library(bigmemory)

estimate_mode <- function(s) {
  d <- density(s)
  return(d$x[which.max(d$y)])
}


hdi_upper<- function(s){
  m <- HPDinterval(mcmc(s))
  return(m["var1","upper"])
}

hdi_lower<- function(s){
  m <- HPDinterval(mcmc(s))
  return(m["var1","lower"])
}
```


# Read in raw file

```{r}


  m1 <-read_csv("../webppl/output/samples-reFactor-RE_mcmc-200000_burn100000_lag10_chain1.csv")%>%mutate(chain = 1)
  m2 <-read_csv("../webppl/output/samples-reFactor-RE_mcmc-200000_burn100000_lag10_chain2.csv")%>%mutate(chain = 2)
  m3 <-read_csv("../webppl/output/samples-reFactor-RE_mcmc-200000_burn100000_lag10_chain3.csv")%>%mutate(chain = 3)
  m4 <-read_csv("../webppl/output/samples-reFactor-RE_mcmc-200000_burn100000_lag10_chain4.csv")%>%mutate(chain = 4)
  m5 <-read_csv("../webppl/output/samples-reFactor-RE_mcmc-200000_burn100000_lag10_chain5.csv")%>%mutate(chain = 5)
  m6 <-read_csv("../webppl/output/samples-reFactor-RE_mcmc-200000_burn100000_lag10_chain6.csv")%>%mutate(chain = 6)

  
model <- bind_rows(
  m1,m2,m3,m4,m5,m6
)


saveRDS(m6, "../saves/m6.rds")


model <- bind_rows(
  readRDS("../saves/m1.rds"),
  readRDS("../saves/m2.rds"),
  readRDS("../saves/m3.rds"),
  readRDS("../saves/m4.rds"),
  readRDS("../saves/m5.rds"),
  readRDS("../saves/m6.rds")
)


```

# Model predictions

```{r}
model_pred_prag <- model %>%
  filter(a == "modelPrediction",
         b == "pragmatic")%>%
  select(-a, -h)%>%
  rename(model = b, 
         parameter = c,
         alignment = d,
         item = e,
         age = f, 
         pred = g)

saveRDS(model_pred_prag, "../saves/model_pred_prag.rds")

model_pred <- model %>%
  filter(a == "modelPrediction",
         b == "global")%>%
  select(-a, -h)%>%
  rename(model = b, 
         parameter = c,
         alignment = d,
         item = e,
         age = f, 
         pred = g)

saveRDS(model_pred, "../saves/model_pred_global.rds")

model_pred_flat <- model %>%
  filter(a == "modelPrediction",
         b == "flat")%>%
  select(-a, -h)%>%
  rename(model = b, 
         parameter = c,
         alignment = d,
         item = e,
         age = f, 
         pred = g)

saveRDS(model_pred_flat, "../saves/model_pred_flat.rds")

model_pred_prior <- model %>%
  filter(a == "modelPrediction",
         b == "prior")%>%
  select(-a, -h)%>%
  rename(model = b, 
         parameter = c,
         alignment = d,
         item = e,
         age = f, 
         pred = g)

saveRDS(model_pred_prior, "../saves/model_pred_prior.rds")


```

# Model Parameters 

```{r}
item_params <-  model %>%
  filter(b == "items")%>%
  select(-a,-b, -e, -f, -h)%>%
    rename(item = c,
         parameter = d,
         value = g)

saveRDS(item_params, "../saves/item_params.rds")

global_params <- model %>%
  filter(b == "parameters")%>%
  select(-a,-b, -e,-f, -h)%>%
    rename(parameter = c,
         type = d,
         value = g)

saveRDS(global_params, "../saves/global_params.rds")

item_sigma<- model %>%
  filter(b == "sigma",
         c == "global_sem_sigmas")%>%
  select(-a,-b, -e,-f,-h)%>%
    rename(parameter = c,
         type = d,
         value = g)

saveRDS(item_sigma, "../saves/item_sigma_re.rds")

subject_sigma<- model %>%
  filter(b == "sigma", 
         c != "global_sem_sigmas")%>%
  select(-a,-b, -e,-f,-h, -d)%>%
    rename(parameter = c,
         value = g)

saveRDS(subject_sigma, "../saves/subject_sigma.rds")
```

